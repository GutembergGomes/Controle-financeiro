<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceControl Pro - Versão 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Import Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    </script>
    
    <!-- Gemini AI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai@0.12.0"
        }
      }
    </script>
    <script type="module">
      import { GoogleGenerativeAI } from "@google/generative-ai";

      window.processWithGemini = async function(text, apiKey) {
        const genAI = new GoogleGenerativeAI(apiKey);
        
        // Função auxiliar para tentar gerar conteúdo com um modelo
        const tryGenerate = async (modelName) => {
            try {
                const model = genAI.getGenerativeModel({ model: modelName });
                const prompt = `
                Analise o seguinte texto extraído de um documento financeiro (extrato, recibo ou planilha) e extraia as transações ou dívidas.
                Retorne APENAS um array JSON válido (sem markdown, sem \`\`\`).
                
                Formato do objeto JSON:
                {
                    "description": "Descrição curta e clara",
                    "amount": 0.00 (número positivo, float. SE FOR PARCELADO, É O VALOR DA PARCELA),
                    "type": "expense" ou "income" (negativo é expense),
                    "date": "YYYY-MM-DD" (se não tiver data, use ${new Date().toISOString().split('T')[0]}),
                    "installments": 1 (número de parcelas. Se for "20X" ou "1/20", retorne 20. Se não tiver, 1)
                }

                Regras:
                1. Ignore saldos e lixo.
                2. Identifique parcelamentos (ex: "10X", "01/10").
                3. Se encontrar "Valor da Parcela" ou tabela com "Vezes", assuma que o amount é o valor MENSAL.
                4. IGNORAR linhas de totais ou subtotais (ex: "Total", "Soma", "Parcela Mensal Total").
                5. Certifique-se de capturar TODAS as linhas da tabela, incluindo financiamentos e empréstimos.
                
                Texto para análise:
                ${text}
                `;

                const result = await model.generateContent(prompt);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.warn(`Erro com modelo ${modelName}:`, error);
                return null;
            }
        };

        try {
            // Tenta primeiro com Flash (mais rápido e barato)
            let textResponse = await tryGenerate("gemini-1.5-flash");
            
            // Se falhar, tenta Flash Latest
            if (!textResponse) {
                console.log("Tentando fallback para gemini-1.5-flash-latest...");
                textResponse = await tryGenerate("gemini-1.5-flash-latest");
            }

            // Se falhar, tenta Pro (fallback final)
            if (!textResponse) {
                console.log("Tentando fallback para gemini-pro...");
                textResponse = await tryGenerate("gemini-pro");
            }

            if (!textResponse) throw new Error("Todos os modelos Gemini falharam.");
            
            // Limpa markdown se o modelo retornar
            const jsonStr = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(jsonStr);
        } catch (error) {
            console.error("Erro Fatal Gemini:", error);
            throw error;
        }
      }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <script>
        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = { 
           apiKey: "AIzaSyAefJVt69iMmI2lph_6mK52PddWpx46kk8", 
           authDomain: "financeiro-6700e.firebaseapp.com", 
           projectId: "financeiro-6700e", 
           storageBucket: "financeiro-6700e.firebasestorage.app", 
           messagingSenderId: "593654083182", 
           appId: "1:593654083182:web:823815c022e2cf1e4ec07f", 
           measurementId: "G-4GEEYWY60B" 
        }; 

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Configuração para evitar erros de conexão (Unknown SID / 400)
        db.settings({ 
            experimentalForceLongPolling: true,
            ignoreUndefinedProperties: true
        });

        const analytics = firebase.analytics();
        
        let currentUser = null;
        let isFirebaseInitialized = true;
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#818CF8',
                        accent: '#06D6A0',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        success: '#10B981',
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'slide-out': 'slideOut 0.3s ease-in',
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'bounce-in': 'bounceIn 0.5s ease-out',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s ease-in-out',
                        'zoom-in': 'zoomIn 0.3s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-20px); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .notification {
            z-index: 9999;
        }
        .modal-overlay {
            backdrop-filter: blur(8px);
        }
        .gradient-border {
            background: linear-gradient(45deg, #5D5CDE, #818CF8, #06D6A0);
            padding: 2px;
            border-radius: 1rem;
        }
        .gradient-border > div {
            background: white;
            border-radius: 0.875rem;
        }
        .dark .gradient-border > div {
            background: #1f2937;
        }
        .floating-action {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 40;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.5s ease;
        }
        @media (max-width: 768px) {
            .floating-action {
                bottom: 1rem;
                right: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Header -->
    <header class="bg-gradient-to-r from-primary to-secondary text-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">FinanceControl Pro 2.0</h1>
                        <p class="text-sm opacity-80">Controle Financeiro Inteligente</p>
                    </div>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <button onclick="showSection('dashboard')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200 active-tab">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button onclick="showSection('transactions')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-exchange-alt mr-2"></i>Transações
                    </button>
                    <button onclick="showSection('budget')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-calculator mr-2"></i>Orçamento
                    </button>
                    <button onclick="showSection('debts')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-credit-card mr-2"></i>Dívidas
                    </button>
                    <button onclick="showSection('goals')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-target mr-2"></i>Metas
                    </button>
                    <button onclick="showSection('investments')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-chart-pie mr-2"></i>Investimentos
                    </button>
                    <button onclick="showSection('reports')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-chart-bar mr-2"></i>Relatórios
                    </button>
                    <button onclick="showSection('tools')" class="nav-btn px-4 py-2 rounded-lg hover:bg-white/20 transition-all duration-200">
                        <i class="fas fa-tools mr-2"></i>Ferramentas
                    </button>
                </nav>
                <div class="flex items-center space-x-3">
                    <div id="userDisplay" class="hidden"></div>
                    <button id="authBtn" onclick="loginWithGoogle()" class="hidden md:flex items-center px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-medium transition-colors border border-white/10">
                        <i class="fab fa-google mr-2"></i>Entrar
                    </button>
                    
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-white/20 transition-colors" title="Alternar tema">
                        <i id="themeIcon" class="fas fa-moon text-lg"></i>
                    </button>
                    <button onclick="showSettingsModal()" class="p-2 rounded-lg hover:bg-white/20 transition-colors" title="Configurações">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                    <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg hover:bg-white/20 transition-colors">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-primary/95 backdrop-blur-sm shadow-lg">
        <div class="px-4 py-3 space-y-1">
            <button onclick="showSection('dashboard'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
            </button>
            <button onclick="showSection('transactions'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-exchange-alt mr-3"></i>Transações
            </button>
            <button onclick="showSection('budget'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-calculator mr-3"></i>Orçamento
            </button>
            <button onclick="showSection('debts'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-credit-card mr-3"></i>Dívidas
            </button>
            <button onclick="showSection('goals'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-target mr-3"></i>Metas
            </button>
            <button onclick="showSection('investments'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-chart-pie mr-3"></i>Investimentos
            </button>
            <button onclick="showSection('reports'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-chart-bar mr-3"></i>Relatórios
            </button>
            <button onclick="showSection('tools'); toggleMobileMenu()" class="block w-full text-left py-3 px-4 text-white hover:bg-white/20 rounded-lg transition-colors">
                <i class="fas fa-tools mr-3"></i>Ferramentas
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 pb-24">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section">
            <!-- Welcome Message -->
            <div class="bg-gradient-to-r from-primary/10 to-secondary/10 dark:from-primary/20 dark:to-secondary/20 p-6 rounded-2xl mb-8 border border-primary/20">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-wave-square mr-2 text-primary"></i>Bem-vindo ao seu Dashboard Financeiro
                        </h2>
                        <p class="text-gray-600 dark:text-gray-300">Acompanhe suas finanças de forma inteligente e tome decisões baseadas em dados reais.</p>
                    </div>
                    <div class="hidden md:block">
                        <div class="text-right">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Última atualização</p>
                            <p id="lastUpdate" class="text-sm font-semibold text-gray-700 dark:text-gray-300"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Section -->
            <div id="alertsSection" class="mb-8 space-y-4">
                <!-- Alerts will be rendered here -->
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-success to-emerald-600 p-6 rounded-2xl text-white shadow-xl transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90 font-medium">Saldo Total</p>
                                <p id="totalBalance" class="text-3xl font-bold mt-1">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-2">Patrimônio atual</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <i class="fas fa-wallet text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-6 rounded-2xl text-white shadow-xl transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90 font-medium">Total Investido</p>
                                <p id="totalInvestmentsDash" class="text-3xl font-bold mt-1">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-2">Carteira de ativos</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <i class="fas fa-chart-line text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white shadow-xl transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90 font-medium">Receitas do Mês</p>
                                <p id="monthlyIncome" class="text-3xl font-bold mt-1">R$ 0,00</p>
                                <p id="incomeChange" class="text-xs opacity-75 mt-2">vs. mês anterior</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <i class="fas fa-arrow-trend-up text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-2xl text-white shadow-xl transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90 font-medium">Despesas do Mês</p>
                                <p id="monthlyExpensesDash" class="text-3xl font-bold mt-1">R$ 0,00</p>
                                <div class="flex flex-col">
                                    <p id="expenseChange" class="text-xs opacity-75 mt-2">vs. mês anterior</p>
                                    <p id="expenseRatio" class="text-xs font-bold mt-1 bg-black/20 inline-block px-2 py-0.5 rounded-lg w-fit">0% da Receita</p>
                                </div>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <i class="fas fa-arrow-trend-down text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white shadow-xl transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90 font-medium">Economia do Mês</p>
                                <p id="monthlySavingsDash" class="text-3xl font-bold mt-1">R$ 0,00</p>
                                <p id="savingsRate" class="text-xs opacity-75 mt-2">Taxa de poupança</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <i class="fas fa-piggy-bank text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                            <i class="fas fa-chart-line mr-2 text-primary"></i>Fluxo de Caixa
                        </h3>
                        <div class="flex space-x-2">
                            <button onclick="changeCashFlowPeriod('6m')" class="px-3 py-1 text-xs bg-primary/20 text-primary rounded-lg period-btn active">6M</button>
                            <button onclick="changeCashFlowPeriod('1y')" class="px-3 py-1 text-xs bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 rounded-lg period-btn">1A</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                            <i class="fas fa-chart-pie mr-2 text-secondary"></i>Despesas por Categoria
                        </h3>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Mês atual</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="expensesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions & Goals Preview -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                            <i class="fas fa-history mr-2 text-accent"></i>Transações Recentes
                        </h3>
                        <button onclick="showSection('transactions')" class="text-primary hover:text-secondary transition-colors text-sm font-medium">
                            Ver todas <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                    <div id="recentTransactions" class="space-y-3 max-h-80 overflow-y-auto">
                        <!-- Recent transactions will be rendered here -->
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                            <i class="fas fa-target mr-2 text-warning"></i>Progresso das Metas
                        </h3>
                        <button onclick="showSection('goals')" class="text-primary hover:text-secondary transition-colors text-sm font-medium">
                            Ver todas <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                    <div id="goalsPreview" class="space-y-4 max-h-80 overflow-y-auto">
                        <!-- Goals preview will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
                    <i class="fas fa-bolt mr-2 text-warning"></i>Ações Rápidas
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <button onclick="openTransactionModal('income')" class="group flex flex-col items-center p-4 bg-gradient-to-br from-success/10 to-success/20 hover:from-success/20 hover:to-success/30 rounded-xl transition-all duration-300 transform hover:scale-105">
                        <div class="bg-success/20 p-3 rounded-full group-hover:bg-success/30 transition-colors mb-2">
                            <i class="fas fa-plus-circle text-success text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 text-center">Receita</span>
                    </button>
                    
                    <button onclick="openTransactionModal('expense')" class="group flex flex-col items-center p-4 bg-gradient-to-br from-danger/10 to-danger/20 hover:from-danger/20 hover:to-danger/30 rounded-xl transition-all duration-300 transform hover:scale-105">
                        <div class="bg-danger/20 p-3 rounded-full group-hover:bg-danger/30 transition-colors mb-2">
                            <i class="fas fa-minus-circle text-danger text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 text-center">Despesa</span>
                    </button>
                    
                    <button onclick="openGoalModal()" class="group flex flex-col items-center p-4 bg-gradient-to-br from-warning/10 to-warning/20 hover:from-warning/20 hover:to-warning/30 rounded-xl transition-all duration-300 transform hover:scale-105">
                        <div class="bg-warning/20 p-3 rounded-full group-hover:bg-warning/30 transition-colors mb-2">
                            <i class="fas fa-target text-warning text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 text-center">Meta</span>
                    </button>
                    
                    <button onclick="openBudgetModal()" class="group flex flex-col items-center p-4 bg-gradient-to-br from-primary/10 to-primary/20 hover:from-primary/20 hover:to-primary/30 rounded-xl transition-all duration-300 transform hover:scale-105">
                        <div class="bg-primary/20 p-3 rounded-full group-hover:bg-primary/30 transition-colors mb-2">
                            <i class="fas fa-calculator text-primary text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 text-center">Orçamento</span>
                    </button>
                    
                    <button onclick="exportData()" class="group flex flex-col items-center p-4 bg-gradient-to-br from-accent/10 to-accent/20 hover:from-accent/20 hover:to-accent/30 rounded-xl transition-all duration-300 transform hover:scale-105">
                        <div class="bg-accent/20 p-3 rounded-full group-hover:bg-accent/30 transition-colors mb-2">
                            <i class="fas fa-download text-accent text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 text-center">Exportar</span>
                    </button>
                    
                    <button onclick="backupData()" class="group flex flex-col items-center p-4 bg-gradient-to-br from-secondary/10 to-secondary/20 hover:from-secondary/20 hover:to-secondary/30 rounded-xl transition-all duration-300 transform hover:scale-105">
                        <div class="bg-secondary/20 p-3 rounded-full group-hover:bg-secondary/30 transition-colors mb-2">
                            <i class="fas fa-cloud-upload text-secondary text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 text-center">Backup</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Transactions Section -->
        <section id="transactions" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                        <i class="fas fa-exchange-alt mr-3 text-primary"></i>Transações
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">Gerencie suas receitas e despesas</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                    <button onclick="openTransactionModal('income')" class="bg-gradient-to-r from-success to-emerald-600 hover:from-success/90 hover:to-emerald-600/90 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Nova Receita
                    </button>
                    <button onclick="openTransactionModal('expense')" class="bg-gradient-to-r from-danger to-red-600 hover:from-danger/90 hover:to-red-600/90 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-minus mr-2"></i>Nova Despesa
                    </button>
                </div>
            </div>

            <!-- Financial Suggestion -->
            <div id="financialSuggestion" class="hidden mb-8 p-4 rounded-2xl border-l-4 shadow-md transition-all duration-300">
                <div class="flex items-start">
                    <div class="p-2 rounded-full mr-4 bg-white/20">
                        <i id="suggestionIcon" class="fas fa-lightbulb text-xl"></i>
                    </div>
                    <div>
                        <h4 id="suggestionTitle" class="font-bold text-lg mb-1">Análise Financeira</h4>
                        <p id="suggestionText" class="text-sm opacity-90"></p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 mb-8">
                <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-white">
                    <i class="fas fa-filter mr-2 text-secondary"></i>Filtros
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo</label>
                        <select id="filterType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors">
                            <option value="">Todos os tipos</option>
                            <option value="income">Receitas</option>
                            <option value="expense">Despesas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                        <select id="filterCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mês/Ano</label>
                        <input type="month" id="filterMonth" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors">
                    </div>
                    <div class="flex items-end">
                        <button onclick="clearFilters()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                            <i class="fas fa-times mr-2"></i>Limpar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-2xl border border-blue-200 dark:border-blue-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-blue-600 dark:text-blue-400 mb-1">Transações Totais</p>
                            <p id="totalTransactions" class="text-2xl font-bold text-blue-800 dark:text-blue-200">0</p>
                        </div>
                        <i class="fas fa-list text-blue-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-6 rounded-2xl border border-green-200 dark:border-green-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-600 dark:text-green-400 mb-1">Maior Receita</p>
                            <p id="maxIncome" class="text-2xl font-bold text-green-800 dark:text-green-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-arrow-up text-green-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/20 dark:to-red-800/20 p-6 rounded-2xl border border-red-200 dark:border-red-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-red-600 dark:text-red-400 mb-1">Maior Despesa</p>
                            <p id="maxExpense" class="text-2xl font-bold text-red-800 dark:text-red-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-arrow-down text-red-500 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Transactions List -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">
                            <i class="fas fa-history mr-2 text-primary"></i>Histórico de Transações
                        </h3>
                        <div class="flex items-center space-x-4">
                            <div id="transactionCount" class="text-sm text-gray-500 dark:text-gray-400 font-medium"></div>
                            <button onclick="exportTransactions()" class="text-accent hover:text-accent/80 transition-colors" title="Exportar transações">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="transactionsList" class="divide-y divide-gray-200 dark:divide-gray-700 max-h-96 overflow-y-auto">
                    <!-- Transactions will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Budget Section -->
        <section id="budget" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                        <i class="fas fa-calculator mr-3 text-primary"></i>Planejamento Orçamentário
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">Controle seus gastos por categoria</p>
                </div>
                <button onclick="openBudgetModal()" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Novo Orçamento
                </button>
            </div>

            <!-- Budget Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-6 rounded-2xl border border-green-200 dark:border-green-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-600 dark:text-green-400 mb-1">Orçamento Total</p>
                            <p id="totalBudget" class="text-2xl font-bold text-green-800 dark:text-green-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-wallet text-green-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-2xl border border-blue-200 dark:border-blue-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-blue-600 dark:text-blue-400 mb-1">Gasto Atual</p>
                            <p id="totalSpent" class="text-2xl font-bold text-blue-800 dark:text-blue-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-credit-card text-blue-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-6 rounded-2xl border border-purple-200 dark:border-purple-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-purple-600 dark:text-purple-400 mb-1">Disponível</p>
                            <p id="budgetRemaining" class="text-2xl font-bold text-purple-800 dark:text-purple-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-piggy-bank text-purple-500 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Budget Categories -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
                    <i class="fas fa-chart-bar mr-2 text-secondary"></i>Orçamento por Categoria
                </h3>
                <div id="budgetCategories" class="space-y-6">
                    <!-- Budget categories will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Debts Section -->
        <section id="debts" class="section hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                        <i class="fas fa-credit-card mr-3 text-primary"></i>Gestão de Dívidas
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">Controle seus cartões e financiamentos</p>
                </div>
                <button onclick="openDebtModal()" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white px-6 py-3 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                    <i class="fas fa-plus mr-2"></i>Nova Dívida
                </button>
            </div>

            <!-- Debt Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-2xl text-white shadow-xl">
                        <p class="text-sm opacity-90 font-medium">Total em Dívidas</p>
                        <p id="totalDebtAmount" class="text-3xl font-bold mt-1">R$ 0,00</p>
                        <p class="text-xs opacity-75 mt-2">Saldo devedor total</p>
                    </div>
                </div>
                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white shadow-xl">
                        <p class="text-sm opacity-90 font-medium">Valor Pago</p>
                        <p id="totalDebtPaid" class="text-3xl font-bold mt-1">R$ 0,00</p>
                        <p class="text-xs opacity-75 mt-2">Amortizado até agora</p>
                    </div>
                </div>
                <div class="gradient-border">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white shadow-xl">
                        <p class="text-sm opacity-90 font-medium">Próxima Parcela</p>
                        <p id="nextDebtInstallment" class="text-3xl font-bold mt-1">R$ 0,00</p>
                        <p class="text-xs opacity-75 mt-2">Estimativa mensal</p>
                    </div>
                </div>
            </div>

            <!-- Debts List -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="debtsList">
                <!-- Debts will be rendered here -->
            </div>
        </section>

        <!-- Goals Section -->
        <section id="goals" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                        <i class="fas fa-target mr-3 text-warning"></i>Metas Financeiras
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">Defina e acompanhe seus objetivos</p>
                </div>
                <button onclick="openGoalModal()" class="bg-gradient-to-r from-warning to-yellow-600 hover:from-warning/90 hover:to-yellow-600/90 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Nova Meta
                </button>
            </div>

            <!-- Goals Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 p-6 rounded-2xl border border-yellow-200 dark:border-yellow-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-yellow-600 dark:text-yellow-400 mb-1">Total de Metas</p>
                            <p id="totalGoals" class="text-2xl font-bold text-yellow-800 dark:text-yellow-200">0</p>
                        </div>
                        <i class="fas fa-list-check text-yellow-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-6 rounded-2xl border border-green-200 dark:border-green-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-600 dark:text-green-400 mb-1">Concluídas</p>
                            <p id="completedGoals" class="text-2xl font-bold text-green-800 dark:text-green-200">0</p>
                        </div>
                        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-2xl border border-blue-200 dark:border-blue-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-blue-600 dark:text-blue-400 mb-1">Em Progresso</p>
                            <p id="activeGoals" class="text-2xl font-bold text-blue-800 dark:text-blue-200">0</p>
                        </div>
                        <i class="fas fa-clock text-blue-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-6 rounded-2xl border border-purple-200 dark:border-purple-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-purple-600 dark:text-purple-400 mb-1">Progresso Médio</p>
                            <p id="averageProgress" class="text-2xl font-bold text-purple-800 dark:text-purple-200">0%</p>
                        </div>
                        <i class="fas fa-chart-line text-purple-500 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div id="goalsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Goals will be rendered here -->
            </div>
        </section>

        <!-- Investments Section -->
        <section id="investments" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                        <i class="fas fa-chart-pie mr-3 text-accent"></i>Investimentos
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">Acompanhe sua carteira de investimentos</p>
                </div>
                <button onclick="openInvestmentModal()" class="bg-gradient-to-r from-accent to-emerald-600 hover:from-accent/90 hover:to-emerald-600/90 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Novo Investimento
                </button>
            </div>

            <!-- Market Ticker -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                        <i class="fas fa-globe-americas mr-2 text-primary"></i>Mercado Hoje
                    </h3>
                    <span class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-green-500 mr-1 animate-pulse"></span>
                        Atualização em tempo real
                    </span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="marketTicker">
                    <!-- Ticker items will be injected here -->
                    <div class="animate-pulse flex space-x-4 bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
                        <div class="rounded-full bg-gray-200 dark:bg-gray-700 h-10 w-10"></div>
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investment Suggestions -->
            <div class="mb-8 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 p-6 rounded-2xl border border-indigo-100 dark:border-indigo-800">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-1">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Sugestões de Investimento
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Recomendações baseadas no seu perfil</p>
                    </div>
                    <select id="investProfile" onchange="updateSuggestions()" class="p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        <option value="conservador">Perfil Conservador</option>
                        <option value="moderado" selected>Perfil Moderado</option>
                        <option value="arrojado">Perfil Arrojado</option>
                    </select>
                </div>
                <div id="investmentSuggestions" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Suggestions will be rendered here -->
                </div>
            </div>

            <!-- Market Catalog -->
            <div class="mb-8 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-1">
                            <i class="fas fa-search-dollar mr-2 text-primary"></i>Explorar Mercado
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Catálogo completo de ativos reais</p>
                    </div>
                    <div class="flex space-x-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto">
                        <button onclick="renderMarketCatalog('rendaFixa')" class="catalog-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-primary text-white" data-tab="rendaFixa">Renda Fixa</button>
                        <button onclick="renderMarketCatalog('acoes')" class="catalog-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600" data-tab="acoes">Ações (B3)</button>
                        <button onclick="renderMarketCatalog('fiis')" class="catalog-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600" data-tab="fiis">FIIs</button>
                        <button onclick="renderMarketCatalog('cripto')" class="catalog-tab px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600" data-tab="cripto">Cripto</button>
                    </div>
                </div>
                <div id="marketCatalogContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Catalog items will be injected here -->
                </div>
            </div>

            <!-- Investment Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 dark:from-emerald-900/20 dark:to-emerald-800/20 p-6 rounded-2xl border border-emerald-200 dark:border-emerald-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-emerald-600 dark:text-emerald-400 mb-1">Total Investido</p>
                            <p id="totalInvested" class="text-2xl font-bold text-emerald-800 dark:text-emerald-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-coins text-emerald-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-2xl border border-blue-200 dark:border-blue-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-blue-600 dark:text-blue-400 mb-1">Valor Atual</p>
                            <p id="currentValue" class="text-2xl font-bold text-blue-800 dark:text-blue-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-6 rounded-2xl border border-green-200 dark:border-green-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-green-600 dark:text-green-400 mb-1">Rendimento</p>
                            <p id="totalReturn" class="text-2xl font-bold text-green-800 dark:text-green-200">R$ 0,00</p>
                        </div>
                        <i class="fas fa-trending-up text-green-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-6 rounded-2xl border border-purple-200 dark:border-purple-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-purple-600 dark:text-purple-400 mb-1">Rentabilidade</p>
                            <p id="returnPercentage" class="text-2xl font-bold text-purple-800 dark:text-purple-200">0%</p>
                        </div>
                        <i class="fas fa-percentage text-purple-500 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Portfolio Allocation Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
                        <i class="fas fa-chart-pie mr-2 text-primary"></i>Alocação da Carteira
                    </h3>
                    <div class="h-64">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
                        <i class="fas fa-chart-bar mr-2 text-secondary"></i>Evolução Patrimonial
                    </h3>
                    <div class="flex items-center justify-center h-64 text-gray-500 dark:text-gray-400 text-center">
                        <p>Adicione mais dados históricos para visualizar a evolução.</p>
                        <!-- Placeholder for future Evolution Chart -->
                    </div>
                </div>
            </div>

            <!-- Investments List -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
                    <i class="fas fa-list mr-2 text-primary"></i>Meus Investimentos
                </h3>
                <div id="investmentsList" class="space-y-4">
                    <!-- Investments will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                    <i class="fas fa-chart-bar mr-3 text-secondary"></i>Relatórios Financeiros
                </h2>
                <p class="text-gray-600 dark:text-gray-400">Análise detalhada das suas finanças</p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 mb-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
                    <i class="fas fa-analytics mr-2 text-accent"></i>Análise Detalhada
                </h3>
                <div id="detailedAnalysis" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Analysis cards will be rendered here -->
                </div>
            </div>

            <!-- Financial Health Score -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-6 text-gray-800 dark:text-white">
                    <i class="fas fa-heart-pulse mr-2 text-danger"></i>Saúde Financeira
                </h3>
                <div id="financialHealth" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Financial health indicators will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Tools Section -->
        <section id="tools" class="section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                    <i class="fas fa-tools mr-3 text-secondary"></i>Ferramentas Financeiras
                </h2>
                <p class="text-gray-600 dark:text-gray-400">Calculadoras e utilitários para planejamento financeiro</p>
            </div>

            <!-- Tools Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Compound Interest Calculator -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-calculator mr-2 text-primary"></i>Juros Compostos
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Calcule o crescimento do seu investimento</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor Inicial (R$)</label>
                            <input type="text" id="compoundPrincipal" oninput="formatCurrencyInput(this)" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="1.000,00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Aporte Mensal (R$)</label>
                            <input type="text" id="compoundMonthlyContribution" oninput="formatCurrencyInput(this)" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="200,00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Taxa de Juros (% ao ano)</label>
                            <input type="number" id="compoundRate" step="0.01" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="12">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Período (anos)</label>
                            <input type="number" id="compoundTime" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="5">
                        </div>
                        <button onclick="calculateCompoundInterest()" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            Calcular
                        </button>
                        <div id="compoundResult" class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl hidden">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Valor Final:</p>
                            <p class="text-2xl font-bold text-primary" id="compoundFinalValue">R$ 0,00</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Rendimento: <span id="compoundEarnings" class="font-semibold text-success">R$ 0,00</span></p>
                        </div>
                    </div>
                </div>

                <!-- Emergency Fund Calculator -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-shield-alt mr-2 text-success"></i>Reserva de Emergência
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Calcule sua reserva ideal</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Gastos Mensais (R$)</label>
                            <input type="text" id="monthlyExpenses" oninput="formatCurrencyInput(this)" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="3.000,00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Meses de Cobertura</label>
                            <select id="emergencyMonths" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                                <option value="3">3 meses (Conservador)</option>
                                <option value="6" selected>6 meses (Recomendado)</option>
                                <option value="12">12 meses (Muito Seguro)</option>
                            </select>
                        </div>
                        <button onclick="calculateEmergencyFund()" class="w-full bg-gradient-to-r from-success to-emerald-600 text-white py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            Calcular
                        </button>
                        <div id="emergencyResult" class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl hidden">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Reserva Recomendada:</p>
                            <p class="text-2xl font-bold text-success" id="emergencyAmount">R$ 0,00</p>
                            <div class="mt-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Valor Atual:</span>
                                    <span id="currentEmergency" class="font-semibold">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Falta:</span>
                                    <span id="emergencyGap" class="font-semibold text-warning">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-database mr-2 text-secondary"></i>Gerenciar Dados
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Backup e importação de dados</p>
                    </div>
                    <div class="space-y-4">
                        <button onclick="exportData()" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-download mr-2"></i>Exportar Dados
                        </button>
                        <div class="relative">
                            <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(event)">
                            <button onclick="document.getElementById('importFile').click()" class="w-full bg-gradient-to-r from-accent to-emerald-600 text-white py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-upload mr-2"></i>Importar Dados
                            </button>
                        </div>
                        <button onclick="clearAllData()" class="w-full bg-gradient-to-r from-danger to-red-600 text-white py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-trash mr-2"></i>Limpar Todos os Dados
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <div class="floating-action">
        <div class="relative">
            <button id="fabMain" onclick="toggleFAB()" class="w-14 h-14 bg-gradient-to-r from-primary to-secondary text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 flex items-center justify-center">
                <i id="fabIcon" class="fas fa-plus text-xl"></i>
            </button>
            <div id="fabMenu" class="absolute bottom-16 right-0 space-y-3 hidden">
                <button onclick="openTransactionModal('income'); toggleFAB()" class="w-12 h-12 bg-success text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 flex items-center justify-center" title="Nova Receita">
                    <i class="fas fa-plus"></i>
                </button>
                <button onclick="openTransactionModal('expense'); toggleFAB()" class="w-12 h-12 bg-danger text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 flex items-center justify-center" title="Nova Despesa">
                    <i class="fas fa-minus"></i>
                </button>
                <button onclick="openGoalModal(); toggleFAB()" class="w-12 h-12 bg-warning text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 flex items-center justify-center" title="Nova Meta">
                    <i class="fas fa-target"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Asset Details Modal with Chart -->
    <div id="assetDetailModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl mx-4 shadow-2xl transform transition-all animate-zoom-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 id="assetDetailTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Detalhes do Ativo</h2>
                        <p id="assetDetailSubtitle" class="text-sm text-gray-500 dark:text-gray-400">Histórico de Preços</p>
                    </div>
                    <button onclick="closeAssetDetailModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="assetDetailChart"></canvas>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button onclick="closeAssetDetailModal()" class="px-6 py-2 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors font-medium">
                        Fechar
                    </button>
                    <button class="px-6 py-2 rounded-xl bg-primary text-white hover:bg-primary/90 transition-colors shadow-lg font-medium flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Adicionar à Carteira
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md animate-bounce-in shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Nova Transação</h3>
                <button onclick="closeTransactionModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="transactionForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-dollar-sign mr-1 text-primary"></i>Valor
                    </label>
                    <input type="text" id="transactionAmount" required oninput="formatCurrencyInput(this)"
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="0,00">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-edit mr-1 text-secondary"></i>Descrição
                    </label>
                    <input type="text" id="transactionDescription" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="Descrição da transação">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-tags mr-1 text-accent"></i>Categoria
                    </label>
                    <select id="transactionCategory" required 
                            class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-calendar mr-1 text-warning"></i>Data
                    </label>
                    <input type="date" id="transactionDate" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-check-circle mr-1 text-success"></i>Status
                    </label>
                    <select id="transactionStatus" required 
                            class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        <option value="paid">Pago / Recebido</option>
                        <option value="pending">Pendente</option>
                    </select>
                </div>
                <div id="transactionDebtContainer" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-credit-card mr-1 text-danger"></i>Vincular a Dívida (Opcional)
                    </label>
                    <select id="transactionDebt" 
                            class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        <option value="">Selecione uma dívida...</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Ao selecionar, o valor será abatido da dívida.</p>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                    <button type="button" onclick="closeTransactionModal()" 
                            class="px-8 py-4 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-xl font-semibold transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Goal Modal -->
    <div id="goalModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md animate-bounce-in shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-target mr-2 text-warning"></i>Nova Meta
                </h3>
                <button onclick="closeGoalModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="goalForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-flag mr-1 text-primary"></i>Nome da Meta
                    </label>
                    <input type="text" id="goalName" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="Ex: Reserva de Emergência">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-bullseye mr-1 text-success"></i>Valor Alvo
                    </label>
                    <input type="text" id="goalTarget" required oninput="formatCurrencyInput(this)"
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="0,00">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-calendar-check mr-1 text-warning"></i>Data Limite
                    </label>
                    <input type="date" id="goalDeadline" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-warning to-yellow-600 hover:from-warning/90 hover:to-yellow-600/90 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Criar Meta
                    </button>
                    <button type="button" onclick="closeGoalModal()" 
                            class="px-8 py-4 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-xl font-semibold transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Debt Modal -->
    <div id="debtModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md animate-bounce-in shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-credit-card mr-2 text-primary"></i>Nova Dívida
                </h3>
                <button onclick="closeDebtModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="debtForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-font mr-1 text-primary"></i>Nome/Descrição
                    </label>
                    <input type="text" id="debtName" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="Ex: TV Magalu, Empréstimo">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-money-bill mr-1 text-success"></i>Valor À Vista
                        </label>
                        <input type="text" id="debtOriginalAmount" required oninput="formatCurrencyInput(this); calculateDebtInfo()"
                               class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                               placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-calendar-alt mr-1 text-warning"></i>1ª Parcela
                        </label>
                        <input type="date" id="debtDueDate" required 
                               class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-layer-group mr-1 text-info"></i>Nº Parcelas
                        </label>
                        <input type="number" id="debtTotalInstallments" min="1" required oninput="calculateDebtInfo()"
                               class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                               placeholder="12">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-coins mr-1 text-accent"></i>Valor Parcela
                        </label>
                        <input type="text" id="debtInstallmentValue" required oninput="formatCurrencyInput(this); calculateDebtInfo()"
                               class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                               placeholder="0,00">
                    </div>
                </div>

                <div id="debtCalculationInfo" class="hidden p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-100 dark:border-gray-600">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600 dark:text-gray-400">Total Final:</span>
                        <span id="calcTotalDebt" class="font-bold text-gray-800 dark:text-white">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Juros Estimados:</span>
                        <span id="calcInterest" class="font-bold text-danger">R$ 0,00</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-check-circle mr-1 text-secondary"></i>Parcelas Já Pagas (Anteriores)
                    </label>
                    <input type="number" id="debtPaidInstallments" min="0" value="0"
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="0">
                    <p class="text-xs text-gray-500 mt-1">Transações passadas serão geradas como "Pagas".</p>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                    <button type="button" onclick="closeDebtModal()" 
                            class="px-8 py-4 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-xl font-semibold transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md animate-bounce-in shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-calculator mr-2 text-primary"></i>Novo Orçamento
                </h3>
                <button onclick="closeBudgetModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="budgetForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-tags mr-1 text-accent"></i>Categoria
                    </label>
                    <select id="budgetCategory" required 
                            class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-dollar-sign mr-1 text-primary"></i>Valor Mensal
                    </label>
                    <input type="text" id="budgetAmount" required oninput="formatCurrencyInput(this)"
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="0,00">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-calendar mr-1 text-warning"></i>Mês/Ano
                    </label>
                    <input type="month" id="budgetMonth" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                    <button type="button" onclick="closeBudgetModal()" 
                            class="px-8 py-4 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-xl font-semibold transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Investment Modal -->
    <div id="investmentModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md animate-bounce-in shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-chart-pie mr-2 text-accent"></i>Novo Investimento
                </h3>
                <button onclick="closeInvestmentModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="investmentForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-signature mr-1 text-primary"></i>Nome do Investimento
                    </label>
                    <input type="text" id="investmentName" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="Ex: Tesouro Direto">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-layer-group mr-1 text-secondary"></i>Tipo
                    </label>
                    <select id="investmentType" required 
                            class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        <option value="">Selecione o tipo</option>
                        <option value="renda-fixa">Renda Fixa</option>
                        <option value="renda-variavel">Renda Variável</option>
                        <option value="fundo">Fundo de Investimento</option>
                        <option value="cripto">Criptomoedas</option>
                        <option value="imovel">Imóveis</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-dollar-sign mr-1 text-success"></i>Valor Investido
                    </label>
                    <input type="text" id="investmentAmount" required oninput="formatCurrencyInput(this)"
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="0,00">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-chart-line mr-1 text-accent"></i>Valor Atual
                    </label>
                    <input type="text" id="investmentCurrentValue" required oninput="formatCurrencyInput(this)"
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                           placeholder="0,00">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-calendar mr-1 text-warning"></i>Data do Investimento
                    </label>
                    <input type="date" id="investmentDate" required 
                           class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-accent to-emerald-600 hover:from-accent/90 hover:to-emerald-600/90 text-white py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                    <button type="button" onclick="closeInvestmentModal()" 
                            class="px-8 py-4 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 rounded-xl font-semibold transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-lg animate-bounce-in shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-cog mr-2 text-secondary"></i>Configurações
                </h3>
                <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-file-import mr-2 text-primary"></i>Importar Dados (IA Beta)
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="document.getElementById('importExcel').click()" 
                                class="flex flex-col items-center justify-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all group">
                            <i class="fas fa-file-excel text-2xl text-green-600 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Excel / CSV</span>
                        </button>
                        <input type="file" id="importExcel" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleExcelImport(this)">

                        <button onclick="document.getElementById('importImage').click()" 
                                class="flex flex-col items-center justify-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all group">
                            <i class="fas fa-camera text-2xl text-blue-600 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Foto / Imagem</span>
                        </button>
                        <input type="file" id="importImage" accept="image/*" class="hidden" onchange="handleImageImport(this)">

                        <button onclick="document.getElementById('importPdf').click()" 
                                class="flex flex-col items-center justify-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all group">
                            <i class="fas fa-file-pdf text-2xl text-red-600 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Extrato PDF</span>
                        </button>
                        <input type="file" id="importPdf" accept=".pdf" class="hidden" onchange="handlePdfImport(this)">
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                        <i class="fas fa-robot mr-1"></i>
                        A IA tentará reconhecer automaticamente datas, valores e descrições.
                    </p>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-database mr-2 text-accent"></i>Backup e Restauração
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="exportData()" 
                                class="flex items-center justify-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all group">
                            <i class="fas fa-download text-xl text-blue-600 mr-3 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Exportar Backup (JSON)</span>
                        </button>
                        <button onclick="document.getElementById('importBackup').click()" 
                                class="flex items-center justify-center p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all group">
                            <i class="fas fa-upload text-xl text-orange-600 mr-3 group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Restaurar Backup</span>
                        </button>
                        <input type="file" id="importBackup" accept=".json" class="hidden" onchange="importData(this)">
                    </div>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-sliders-h mr-2 text-accent"></i>Preferências
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Moeda</label>
                            <select id="currencySelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                                <option value="BRL">Real Brasileiro (R$)</option>
                                <option value="USD">Dólar Americano ($)</option>
                                <option value="EUR">Euro (€)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Formato de Data</label>
                            <select id="dateFormatSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                                <option value="pt-BR">DD/MM/AAAA</option>
                                <option value="en-US">MM/DD/AAAA</option>
                                <option value="en-GB">DD/MM/AAAA</option>
                            </select>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                            <label class="block text-sm font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600 mb-2">
                                <i class="fas fa-magic mr-2"></i>Gemini AI (Opcional)
                            </label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                                Para uma importação MUITO mais precisa, cole sua API Key do Google Gemini abaixo. 
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-primary hover:underline">Gerar Key Grátis</a>
                            </p>
                            <input type="password" id="geminiApiKey" placeholder="Cole sua API Key aqui (começa com AIza...)" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="resetSettings()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                        Restaurar Padrão
                    </button>
                    <button onclick="saveSettings()" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                        Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>

        // --- SISTEMA DE IMPORTAÇÃO INTELIGENTE (IA BETA) ---
        const SmartParser = {
            // Regex patterns para identificar dados
            patterns: {
                date: /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/g,
                money: /(?:R\$\s*)?([\d\.]+,\d{2})/g, // Formato PT-BR 1.000,00
                moneyUS: /(?:\$\s*)?([\d,]+\.\d{2})/g, // Formato US 1,000.00
                installments: /(\d+)\s*[xX]/ // Padrão para parcelas (ex: 10x)
            },

            // Tenta adivinhar se é uma transação válida
            parseText: async function(text) {
                // VERIFICA SE TEM API KEY DO GEMINI CONFIGURADA (Prioriza localStorage, senão usa Default do código)
                const apiKey = localStorage.getItem('geminiApiKey') || "AIzaSyDNJYeFWmGzcGo5AtRDwNf5uqzKRIHHEvE";
                
                if (apiKey && window.processWithGemini) {
                    try {
                        showNotification('Enviando dados para análise do Gemini AI...', 'info');
                        const geminiTransactions = await window.processWithGemini(text, apiKey);
                        
                        // Valida e formata retorno do Gemini
                        return geminiTransactions.map(t => ({
                            id: Date.now() + Math.random(),
                            description: t.description || 'Transação Gemini',
                            amount: parseFloat(t.amount),
                            type: t.type === 'expense' ? 'expense' : 'income',
                            category: 'Outros',
                            date: t.date,
                            status: 'paid',
                            installments: t.installments || 1
                        }));
                    } catch (e) {
                        console.error("Falha no Gemini, usando fallback regex", e);
                        showNotification('Erro na IA, usando método padrão...', 'warning');
                    }
                }

                // FALLBACK: Regex simples (código original)
                const lines = text.split('\n');
                const transactions = [];
                
                lines.forEach(line => {
                    // Ignora linhas muito curtas
                    if (line.length < 5) return; 

                    // Ignora linhas de TOTAL, SOMA ou SALDO (para evitar duplicidade com o rodapé)
                    if (line.toUpperCase().includes('TOTAL') || 
                        line.toUpperCase().includes('SOMA') || 
                        line.toUpperCase().includes('SALDO')) {
                        return;
                    }

                    // Busca data
                    const dateMatch = line.match(this.patterns.date);
                    // Busca valor
                    const moneyMatch = line.match(this.patterns.money) || line.match(this.patterns.moneyUS);
                    // Busca parcelas
                    const installmentMatch = line.match(this.patterns.installments);
                    let installments = 1;
                    if (installmentMatch) {
                        installments = parseInt(installmentMatch[1]);
                    }

                    if (moneyMatch) { 
                        // Tenta extrair a descrição (texto que não é data nem valor)
                        let description = line
                            .replace(this.patterns.money, '')
                            .replace(this.patterns.moneyUS, '')
                            .replace(this.patterns.installments, '')
                            .trim()
                            .replace(/[^\w\s\u00C0-\u00FF]/g, '') // Remove caracteres especiais
                            .replace(/\s+/g, ' '); // Remove espaços duplos
                        
                        if (dateMatch) {
                            description = description.replace(this.patterns.date, '').trim();
                        }

                        if (description.length > 2) { 
                            // Formata data para YYYY-MM-DD
                            let formattedDate;
                            if (dateMatch) {
                                const dateParts = dateMatch[0].split(/[\/\-\.]/);
                                // Assume formato DD/MM/YYYY
                                let year = dateParts[2];
                                if (year.length === 2) year = '20' + year;
                                formattedDate = `${year}-${dateParts[1].padStart(2,'0')}-${dateParts[0].padStart(2,'0')}`;
                            } else {
                                // Se não tiver data, usa hoje
                                formattedDate = new Date().toISOString().split('T')[0];
                            }

                            // Formata valor
                            let amountStr = moneyMatch[0].replace('R$', '').replace('$', '').trim();
                            let amount = 0;
                            if (amountStr.includes(',')) {
                                // PT-BR
                                amount = parseFloat(amountStr.replace(/\./g, '').replace(',', '.'));
                            } else {
                                // US
                                amount = parseFloat(amountStr.replace(/,/g, ''));
                            }

                            transactions.push({
                                id: Date.now() + Math.random(),
                                description: description || 'Item Importado',
                                amount: Math.abs(amount),
                                type: 'expense',
                                category: 'Outros', 
                                date: formattedDate,
                                status: 'paid',
                                installments: installments
                            });
                        }
                    }
                });
                return transactions;
            }
        };

        // Handlers de Importação
        function handleExcelImport(input) {
            const file = input.files[0];
            if (!file) return;

            showNotification('Lendo arquivo Excel...', 'info');
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1}); // Array de arrays
                    
                    let textBuffer = "";
                    jsonData.forEach(row => {
                        textBuffer += row.join(" ") + "\n";
                    });

                    const transactions = await SmartParser.parseText(textBuffer);
                    processImportedTransactions(transactions);
                    
                } catch (error) {
                    console.error(error);
                    showNotification('Erro ao ler Excel', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            input.value = ''; // Reset input
        }

        function handleImageImport(input) {
            const file = input.files[0];
            if (!file) return;

            showNotification('Processando imagem com OCR (pode demorar)...', 'info');
            
            Tesseract.recognize(
                file,
                'por', // Português
                { logger: m => console.log(m) }
            ).then(async ({ data: { text } }) => {
                console.log("Texto extraído:", text);
                const transactions = await SmartParser.parseText(text);
                processImportedTransactions(transactions);
            }).catch(err => {
                console.error(err);
                showNotification('Erro ao processar imagem', 'error');
            });
            input.value = '';
        }

        async function handlePdfImport(input) {
            const file = input.files[0];
            if (!file) return;

            showNotification('Lendo PDF...', 'info');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                let fullText = "";

                // Lê todas as páginas
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + "\n";
                }

                console.log("Texto PDF:", fullText);
                const transactions = await SmartParser.parseText(fullText);
                processImportedTransactions(transactions);

            } catch (error) {
                console.error(error);
                showNotification('Erro ao ler PDF', 'error');
            }
            input.value = '';
        }

        function processImportedTransactions(transactions) {
            if (transactions.length === 0) {
                showNotification('Nenhuma transação identificada.', 'warning');
                return;
            }

            let newDebtsCount = 0;
            let newTransCount = 0;

            transactions.forEach(t => {
                // SE TIVER MAIS DE 1 PARCELA, É DÍVIDA
                if (t.installments && t.installments > 1) {
                    const installmentValue = t.amount;
                    const totalAmount = installmentValue * t.installments; // Valor da Parcela * Vezes
                    
                    const newDebt = {
                        id: Date.now() + Math.random(),
                        name: t.description,
                        originalAmount: totalAmount, // Assume sem juros no import
                        totalAmount: totalAmount,
                        totalInstallments: t.installments,
                        paidInstallments: 0,
                        paidAmount: 0,
                        installmentValue: installmentValue,
                        dueDate: t.date,
                        date: t.date
                    };

                    // Verifica duplicidade em dívidas
                    if (!appData.debts) appData.debts = [];
                    const isDuplicate = appData.debts.some(d => d.name === newDebt.name && Math.abs(d.totalAmount - newDebt.totalAmount) < 0.01);
                    
                    if (!isDuplicate) {
                        appData.debts.push(newDebt);
                        newDebtsCount++;

                        // Gerar transações das parcelas para a dívida importada
                        const [y, m, d] = t.date.split('-').map(Number);
                        for (let i = 0; i < t.installments; i++) {
                            const instDate = new Date(y, m - 1 + i, d);
                            const dateString = instDate.toISOString().split('T')[0];
                            
                            appData.transactions.unshift({
                                id: Date.now() + i + Math.random(),
                                description: `${t.description} (${i+1}/${t.installments})`,
                                amount: installmentValue,
                                type: 'expense',
                                category: 'Dívidas',
                                date: dateString,
                                status: 'pending',
                                debtId: newDebt.id
                            });
                        }
                    }

                } else {
                    // Transação Comum
                    const isDuplicate = appData.transactions.some(existingT => 
                        existingT.date === t.date && 
                        Math.abs(existingT.amount - t.amount) < 0.01 &&
                        existingT.description === t.description
                    );

                    if (!isDuplicate) {
                        // Remove campo installments antes de salvar transação comum
                        delete t.installments;
                        appData.transactions.unshift(t);
                        newTransCount++;
                    }
                }
            });

            if (newDebtsCount === 0 && newTransCount === 0) {
                showNotification('Nenhum dado novo importado.', 'info');
                return;
            }

            saveData();
            updateAllDisplays(); // Vai atualizar dívidas e transações
            closeSettingsModal();
            
            let msg = '';
            if (newTransCount > 0) msg += `${newTransCount} transações `;
            if (newDebtsCount > 0) msg += `${newTransCount > 0 ? 'e ' : ''}${newDebtsCount} dívidas `;
            msg += 'importadas com sucesso!';
            
            showNotification(msg, 'success');
        }

        function exportData() {
            try {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `financeiro_backup_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Backup exportado com sucesso!', 'success');
            } catch (e) {
                console.error(e);
                showNotification('Erro ao exportar backup', 'error');
            }
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Validação básica
                    if (!json.transactions && !json.debts && !json.cards) {
                        throw new Error("Formato de arquivo inválido. O arquivo JSON deve conter transactions, debts ou cards.");
                    }

                    if (confirm('ATENÇÃO: A importação irá SUBSTITUIR TODOS os dados atuais.\n\nRecomendamos exportar um backup antes de continuar.\n\nDeseja realmente substituir os dados atuais pelos do arquivo?')) {
                        // Mescla com estrutura padrão para garantir compatibilidade
                        appData = dataManager.validateAndMergeData(json);

                        saveData();
                        updateAllDisplays();
                        
                        // Atualiza configurações visuais se necessário
                        if (appData.settings && appData.settings.currency) {
                            const currencySelect = document.getElementById('currencySelect');
                            if (currencySelect) currencySelect.value = appData.settings.currency;
                        }
                        
                        showNotification('Dados restaurados com sucesso!', 'success');
                        closeSettingsModal();
                    }
                } catch (error) {
                    console.error(error);
                    showNotification('Erro ao restaurar backup: Arquivo inválido', 'error');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        // --- SISTEMA DE PERSISTÊNCIA ROBUSTO ---
        class DataManager {
            constructor() {
                this.storageKey = 'financeControlPro';
                this.isLocalStorageAvailable = this.checkLocalStorage();
                
                // Load Gemini Key if exists or use default from code
                let geminiKey = localStorage.getItem('geminiApiKey');
                if (!geminiKey) {
                    geminiKey = "AIzaSyDNJYeFWmGzcGo5AtRDwNf5uqzKRIHHEvE";
                    try { localStorage.setItem('geminiApiKey', geminiKey); } catch(e){}
                }

                if(geminiKey) {
                    setTimeout(() => {
                        const input = document.getElementById('geminiApiKey');
                        if(input) input.value = geminiKey;
                    }, 1000); // Delay to ensure DOM is ready
                }
            }

            // ... Métodos existentes ...

            async loadFromFirebase(userId) {
                if (!isFirebaseInitialized || !db) return null;
                
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    if (doc.exists) {
                        const firebaseData = JSON.parse(doc.data().data);
                        console.log("Dados recuperados do Firebase");
                        return this.validateAndMergeData(firebaseData);
                    }
                    return null;
                } catch (error) {
                    console.error("Erro ao carregar do Firebase:", error);
                    showNotification("Erro ao sincronizar dados da nuvem", "error");
                    return null;
                }
            }

            async saveToFirebase(data, userId) {
                if (!isFirebaseInitialized || !db) return;

                try {
                    const serializedData = JSON.stringify(data);
                    await db.collection('users').doc(userId).set({
                        data: serializedData,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                        email: currentUser.email
                    });
                    console.log("Dados sincronizados com Firebase");
                    showNotification("Dados salvos na nuvem!", "success");
                } catch (error) {
                    console.error("Erro ao salvar no Firebase:", error);
                    showNotification("Erro ao salvar na nuvem", "warning");
                }
            }

            async clearFromFirebase(userId) {
                if (!isFirebaseInitialized || !db) return;
                try {
                    await db.collection('users').doc(userId).delete();
                    console.log("Dados removidos do Firebase");
                    showNotification("Dados removidos da nuvem!", "success");
                } catch (error) {
                    console.error("Erro ao remover do Firebase:", error);
                    showNotification("Erro ao limpar dados da nuvem", "error");
                }
            }


            checkLocalStorage() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch(e) {
                    console.warn('LocalStorage não disponível:', e);
                    return false;
                }
            }

            save(data) {
                try {
                    if (!this.isLocalStorageAvailable) {
                        console.warn('LocalStorage não disponível - dados não salvos');
                        return false;
                    }

                    const serializedData = JSON.stringify(data);
                    localStorage.setItem(this.storageKey, serializedData);
                    console.log('Dados salvos com sucesso');
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar dados:', error);
                    showNotification('Erro ao salvar dados!', 'error');
                    return false;
                }
            }

            load() {
                try {
                    if (!this.isLocalStorageAvailable) {
                        console.warn('LocalStorage não disponível - usando dados padrão');
                        return this.getDefaultData();
                    }

                    const data = localStorage.getItem(this.storageKey);
                    if (!data) {
                        console.log('Nenhum dado salvo encontrado - usando dados padrão');
                        return this.getDefaultData();
                    }

                    const parsedData = JSON.parse(data);
                    console.log('Dados carregados com sucesso');
                    return this.validateAndMergeData(parsedData);
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    showNotification('Erro ao carregar dados salvos!', 'warning');
                    return this.getDefaultData();
                }
            }

            getDefaultData() {
                return {
                    transactions: [],
                    goals: [],
                    debts: [],
                    budgets: [],
                    investments: [],
                    categories: {
                        income: ['Salário', 'Freelance', 'Investimentos', 'Bonus', 'Vendas', 'Outros'],
                        expense: ['Alimentação', 'Transporte', 'Moradia', 'Saúde', 'Educação', 'Lazer', 'Compras', 'Contas', 'Investimentos', 'Outros']
                    },
                    settings: {
                        currency: 'BRL',
                        dateFormat: 'pt-BR',
                        darkMode: false
                    },
                    version: '2.0'
                };
            }

            validateAndMergeData(loadedData) {
                const defaultData = this.getDefaultData();
                
                // Merge com dados padrão para garantir que todas as propriedades existam
                let mergedData = {
                    transactions: Array.isArray(loadedData.transactions) ? loadedData.transactions : [],
                    goals: Array.isArray(loadedData.goals) ? loadedData.goals : [],
                    debts: Array.isArray(loadedData.debts) ? loadedData.debts : [],
                    budgets: Array.isArray(loadedData.budgets) ? loadedData.budgets : [],
                    investments: Array.isArray(loadedData.investments) ? loadedData.investments : [],
                    categories: {
                        income: Array.isArray(loadedData.categories?.income) ? loadedData.categories.income : defaultData.categories.income,
                        expense: Array.isArray(loadedData.categories?.expense) ? loadedData.categories.expense : defaultData.categories.expense
                    },
                    settings: {
                        ...defaultData.settings,
                        ...loadedData.settings
                    },
                    version: loadedData.version || '2.0'
                };

                // Ensure 'Investimentos' exists in expense categories (migration)
                if (!mergedData.categories.expense.includes('Investimentos')) {
                    mergedData.categories.expense.push('Investimentos');
                }

                // CLEANUP: Remove orphaned debt transactions
                // Se uma transação tem debtId/linkedDebtId mas a dívida não existe, ela é órfã
                if (mergedData.transactions.length > 0) {
                    const originalCount = mergedData.transactions.length;
                    mergedData.transactions = mergedData.transactions.filter(t => {
                        const debtId = t.debtId || t.linkedDebtId;
                        if (!debtId) return true; // Keep regular transactions
                        
                        // Check if debt exists
                        const debtExists = mergedData.debts.some(d => d.id === debtId);
                        return debtExists;
                    });
                    
                    if (mergedData.transactions.length < originalCount) {
                        console.log(`Cleanup: Removed ${originalCount - mergedData.transactions.length} orphaned transactions.`);
                    }
                }

                return mergedData;
            }

            clear() {
                try {
                    if (this.isLocalStorageAvailable) {
                        localStorage.removeItem(this.storageKey);
                    }
                    return true;
                } catch (error) {
                    console.error('Erro ao limpar dados:', error);
                    return false;
                }
            }
        }

        // ESTADO GLOBAL DA APLICAÇÃO
        let appData = {};
        let charts = {};
        let currentTransactionType = 'income';
        let fabOpen = false;
        let dataManager = new DataManager();

        // --- FUNÇÕES DE AUTENTICAÇÃO ---
        function loginWithGoogle() {
            if (!isFirebaseInitialized) {
                showNotification("Configure o Firebase no código primeiro!", "warning");
                return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    showNotification("Login realizado com sucesso!", "success");
                }).catch((error) => {
                    console.error("Erro no login:", error);
                    showNotification("Erro ao fazer login: " + error.message, "error");
                });
        }

        function logout() {
            if (!isFirebaseInitialized) return;
            auth.signOut().then(() => {
                showNotification("Desconectado com sucesso", "info");
                setTimeout(() => location.reload(), 1000);
            });
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            const userDisplay = document.getElementById('userDisplay');
            
            if (currentUser) {
                if(authBtn) {
                    authBtn.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Sair';
                    authBtn.onclick = logout;
                    authBtn.classList.add('bg-red-500/20', 'text-red-100', 'border-red-500/30');
                    authBtn.classList.remove('bg-white/10');
                }
                if(userDisplay) {
                    userDisplay.innerHTML = `
                        <div class="flex items-center gap-2 mr-2 bg-white/10 px-3 py-1.5 rounded-full border border-white/10">
                            <img src="${currentUser.photoURL}" class="w-6 h-6 rounded-full">
                            <span class="text-xs font-medium text-white max-w-[100px] truncate">${currentUser.displayName.split(' ')[0]}</span>
                        </div>
                    `;
                    userDisplay.classList.remove('hidden');
                }
            } else {
                if(authBtn) {
                    authBtn.innerHTML = '<i class="fab fa-google mr-2"></i>Entrar';
                    authBtn.onclick = loginWithGoogle;
                    authBtn.classList.remove('bg-red-500/20', 'text-red-100', 'border-red-500/30');
                    authBtn.classList.add('bg-white/10');
                }
                if(userDisplay) userDisplay.classList.add('hidden');
            }
        }

        // FUNÇÕES DE INICIALIZAÇÃO
        function initializeApp() {
            console.log('Inicializando aplicação...');
            
            // Configurar Listener de Auth (Firebase)
            if (isFirebaseInitialized) {
                auth.onAuthStateChanged(async (user) => {
                    currentUser = user;
                    updateAuthUI();
                    
                    if (user) {
                        showNotification(`Sincronizando dados de ${user.displayName}...`, 'info');
                        const cloudData = await dataManager.loadFromFirebase(user.uid);
                        if (cloudData) {
                            appData = cloudData;
                            updateAllDisplays();
                            showNotification("Dados da nuvem carregados!", "success");
                        } else {
                            // Se é o primeiro login e tem dados locais, salva na nuvem
                            if (appData.transactions.length > 0) {
                                showNotification("Fazendo backup dos dados locais...", "info");
                                saveData();
                            }
                        }
                    }
                });
            } else {
                // Se não tem firebase configurado, mostra botão de login desabilitado ou avisa no console
                console.log("Modo offline ativo");
            }

            // Carregar dados locais inicialmente
            appData = dataManager.load();
            console.log('Dados carregados:', appData);
            
            // Configurar tema
            initializeDarkMode();
            
            // Configurar datas padrão
            setupDefaultDates();
            
            // Configurar listeners
            setupEventListeners();
            
            // Atualizar dropdowns
            updateAllDropdowns();
            
            // Dados de exemplo removidos conforme solicitado

            
            // Atualizar tela
            updateAllDisplays();
            
            // Inicializar gráficos
            setTimeout(initializeCharts, 100);
            
            // Atualizar timestamp
            updateLastUpdateTime();
            
            console.log('Aplicação inicializada com sucesso');
        }

        function initializeDarkMode() {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (appData.settings.darkMode === undefined) {
                appData.settings.darkMode = prefersDark;
            }
            
            updateDarkMode();
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (appData.settings.darkMode === undefined) {
                    appData.settings.darkMode = event.matches;
                    updateDarkMode();
                    saveData();
                }
            });
        }

        function setupDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            document.getElementById('transactionDate').value = today;
            document.getElementById('investmentDate').value = today;
            document.getElementById('filterMonth').value = currentMonth;
            document.getElementById('budgetMonth').value = currentMonth;
            
            document.getElementById('goalDeadline').min = today;
        }

        function setupEventListeners() {
            // Form listeners
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            document.getElementById('goalForm').addEventListener('submit', handleGoalSubmit);
            document.getElementById('budgetForm').addEventListener('submit', handleBudgetSubmit);
            document.getElementById('investmentForm').addEventListener('submit', handleInvestmentSubmit);
            const debtForm = document.getElementById('debtForm');
            if (debtForm) debtForm.addEventListener('submit', handleDebtSubmit);

            // Filter listeners
            document.getElementById('filterType').addEventListener('change', applyFilters);
            document.getElementById('filterCategory').addEventListener('change', applyFilters);
            document.getElementById('filterMonth').addEventListener('change', applyFilters);
        }



        // FUNÇÕES DE SALVAMENTO E CARREGAMENTO
        function saveData() {
            // Salva localmente
            const success = dataManager.save(appData);
            
            // Tenta salvar no Firebase se logado
            if (currentUser && isFirebaseInitialized) {
                dataManager.saveToFirebase(appData, currentUser.uid);
            }

            if (success) {
                updateLastUpdateTime();
            }
            return success;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('pt-BR');
            const element = document.getElementById('lastUpdate');
            if (element) {
                element.textContent = timeString;
            }
        }

        // FUNÇÕES DE NAVEGAÇÃO
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active-tab', 'bg-white/20');
            });

            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(sectionName)) {
                    btn.classList.add('active-tab', 'bg-white/20');
                }
            });

            document.getElementById('mobileMenu').classList.add('hidden');
            
            if (fabOpen) {
                toggleFAB();
            }

            updateSectionData(sectionName);
        }

        function updateSectionData(sectionName) {
            switch(sectionName) {
                case 'dashboard':
                    updateDashboard();
                    updateRecentTransactions();
                    updateGoalsPreview();
                    setTimeout(() => updateCharts(), 100);
                    break;
                case 'transactions':
                    updateTransactionStats();
                    renderTransactions();
                    break;
                case 'budget':
                    updateBudgetOverview();
                    renderBudgetCategories();
                    break;
                case 'debts':
                    updateDebtStats();
                    renderDebts();
                    break;
                case 'goals':
                    updateGoalsStats();
                    renderGoals();
                    break;
                case 'investments':
                    updateInvestmentOverview();
                    renderInvestments();
                    updateMarketTicker();
                    updateSuggestions();
                    renderMarketCatalog('rendaFixa');
                    break;
                case 'reports':
                    renderDetailedAnalysis();
                    renderFinancialHealth();
                    break;
            }
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        }

        function toggleFAB() {
            const fabMenu = document.getElementById('fabMenu');
            const fabIcon = document.getElementById('fabIcon');
            
            fabOpen = !fabOpen;
            
            if (fabOpen) {
                fabMenu.classList.remove('hidden');
                fabIcon.className = 'fas fa-times text-xl';
            } else {
                fabMenu.classList.add('hidden');
                fabIcon.className = 'fas fa-plus text-xl';
            }
        }

        // FUNÇÕES DE MODAL
        function openTransactionModal(type) {
            currentTransactionType = type;
            const title = type === 'income' ? 'Nova Receita' : 'Nova Despesa';
            document.getElementById('modalTitle').innerHTML = `
                <i class="fas ${type === 'income' ? 'fa-plus-circle text-success' : 'fa-minus-circle text-danger'} mr-2"></i>
                ${title}
            `;
            updateTransactionCategories();
            
            // Debt integration
            const debtContainer = document.getElementById('transactionDebtContainer');
            const debtSelect = document.getElementById('transactionDebt');
            
            if (type === 'expense' && appData.debts && appData.debts.length > 0) {
                debtContainer.classList.remove('hidden');
                debtSelect.innerHTML = '<option value="">Selecione uma dívida...</option>';
                
                // Filter active debts
                const activeDebts = appData.debts.filter(d => d.paidInstallments < d.totalInstallments);
                
                if (activeDebts.length > 0) {
                    activeDebts.forEach(debt => {
                        const option = document.createElement('option');
                        option.value = debt.id;
                        option.textContent = `${debt.name} (Restam ${debt.totalInstallments - debt.paidInstallments} parc.)`;
                        debtSelect.appendChild(option);
                    });
                } else {
                    debtContainer.classList.add('hidden');
                }
            } else {
                debtContainer.classList.add('hidden');
            }

            document.getElementById('transactionModal').classList.remove('hidden');
            document.getElementById('transactionAmount').focus();
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        }

        function openGoalModal() {
            document.getElementById('goalModal').classList.remove('hidden');
            document.getElementById('goalName').focus();
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.add('hidden');
            document.getElementById('goalForm').reset();
        }

        function openBudgetModal() {
            updateBudgetCategories();
            document.getElementById('budgetModal').classList.remove('hidden');
            document.getElementById('budgetCategory').focus();
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').classList.add('hidden');
            document.getElementById('budgetForm').reset();
            document.getElementById('budgetMonth').value = new Date().toISOString().slice(0, 7);
        }

        function openInvestmentModal() {
            document.getElementById('investmentModal').classList.remove('hidden');
            document.getElementById('investmentName').focus();
        }

        function closeInvestmentModal() {
            document.getElementById('investmentModal').classList.add('hidden');
            document.getElementById('investmentForm').reset();
            document.getElementById('investmentDate').value = new Date().toISOString().split('T')[0];
        }

        function showSettingsModal() {
            populateSettingsModal();
            document.getElementById('settingsModal').classList.remove('hidden');
            
            // Carrega API Key
            const apiKey = localStorage.getItem('geminiApiKey');
            if(apiKey) {
                document.getElementById('geminiApiKey').value = apiKey;
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // FUNÇÕES DE TRANSAÇÃO
        function handleTransactionSubmit(e) {
            e.preventDefault();
            
            const amount = parseCurrencyInput(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value.trim();
            const category = document.getElementById('transactionCategory').value;
            const date = document.getElementById('transactionDate').value;
            const status = document.getElementById('transactionStatus').value;
            const debtId = document.getElementById('transactionDebt').value;

            if (amount <= 0) {
                showNotification('O valor deve ser maior que zero!', 'error');
                return;
            }

            const transaction = {
                id: Date.now(),
                type: currentTransactionType,
                amount: amount,
                description: description,
                category: category,
                date: date,
                status: status,
                linkedDebtId: debtId ? parseInt(debtId) : null
            };

            // Process Debt Link
            if (currentTransactionType === 'expense' && debtId && appData.debts) {
                const debtIndex = appData.debts.findIndex(d => d.id == debtId);
                if (debtIndex !== -1) {
                    const debt = appData.debts[debtIndex];
                    
                    // Update debt stats
                    debt.paidInstallments = Math.min(debt.paidInstallments + 1, debt.totalInstallments);
                    debt.paidAmount = Math.min(debt.paidAmount + amount, debt.totalAmount);
                    
                    // Check if completed
                    if (debt.paidInstallments >= debt.totalInstallments) {
                        showNotification(`Parabéns! Você quitou a dívida: ${debt.name}`, 'success');
                    }
                }
            }

            appData.transactions.unshift(transaction);
            
            saveData();
            updateAllDisplays();
            updateCharts();
            closeTransactionModal();
            
            const message = currentTransactionType === 'income' ? 'Receita adicionada com sucesso!' : 'Despesa adicionada com sucesso!';
            showNotification(message, 'success');
        }

        function deleteTransaction(id) {
            if (confirm('Tem certeza que deseja excluir esta transação?')) {
                const transaction = appData.transactions.find(t => t.id === id);
                
                // Revert debt changes if linked AND PAID
                // Usa 'debtId' (novo padrão) ou 'linkedDebtId' (legado)
                const debtId = transaction.debtId || transaction.linkedDebtId;
                
                if (transaction && debtId && appData.debts) {
                    const debtIndex = appData.debts.findIndex(d => d.id === debtId);
                    if (debtIndex !== -1) {
                        const debt = appData.debts[debtIndex];
                        // Só decrementa se a transação estava PAGA
                        if (transaction.status === 'paid') {
                            debt.paidInstallments = Math.max(0, (debt.paidInstallments || 0) - 1);
                            debt.paidAmount = Math.max(0, (debt.paidAmount || 0) - transaction.amount);
                        }
                    }
                }

                appData.transactions = appData.transactions.filter(t => t.id !== id);
                saveData();
                updateAllDisplays();
                updateCharts();
                showNotification('Transação removida com sucesso!', 'success');
            }
        }

        function toggleTransactionStatus(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (transaction) {
                const oldStatus = transaction.status;
                const newStatus = oldStatus === 'pending' ? 'paid' : 'pending';
                
                transaction.status = newStatus;

                // Atualizar Dívida Vinculada
                if (transaction.debtId) {
                    const debt = appData.debts.find(d => d.id === transaction.debtId);
                    if (debt) {
                        if (newStatus === 'paid' && oldStatus === 'pending') {
                            // Marcar como pago: incrementa parcela e valor
                            debt.paidInstallments = Math.min((debt.paidInstallments || 0) + 1, debt.totalInstallments);
                            debt.paidAmount = Math.min((debt.paidAmount || 0) + transaction.amount, debt.totalAmount);
                        } else if (newStatus === 'pending' && oldStatus === 'paid') {
                            // Reverter: decrementa parcela e valor
                            debt.paidInstallments = Math.max((debt.paidInstallments || 0) - 1, 0);
                            debt.paidAmount = Math.max((debt.paidAmount || 0) - transaction.amount, 0);
                        }
                    }
                }

                saveData();
                updateAllDisplays();
                updateCharts();
                showNotification(`Transação marcada como ${transaction.status === 'pending' ? 'pendente' : 'paga'}!`, 'success');
            }
        }

        // FUNÇÕES DE META
        function handleGoalSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('goalName').value.trim();
            const target = parseCurrencyInput(document.getElementById('goalTarget').value);
            const deadline = document.getElementById('goalDeadline').value;

            if (target <= 0) {
                showNotification('O valor da meta deve ser maior que zero!', 'error');
                return;
            }

            if (new Date(deadline) <= new Date()) {
                showNotification('A data limite deve ser futura!', 'error');
                return;
            }

            const goal = {
                id: Date.now(),
                name: name,
                target: target,
                current: 0,
                deadline: deadline
            };

            appData.goals.push(goal);
            saveData();
            updateGoalsStats();
            renderGoals();
            updateGoalsPreview();
            closeGoalModal();
            
            showNotification('Meta criada com sucesso!', 'success');
        }

        function updateGoal(id, amount) {
            if (!amount || amount <= 0) {
                showNotification('Digite um valor válido!', 'error');
                return;
            }

            const goal = appData.goals.find(g => g.id === id);
            if (goal) {
                goal.current = Math.min(goal.current + amount, goal.target);
                document.getElementById(`goalInput${id}`).value = '';
                saveData();
                updateGoalsStats();
                renderGoals();
                updateGoalsPreview();
                
                if (goal.current >= goal.target) {
                    showNotification(`🎉 Parabéns! Meta "${goal.name}" alcançada!`, 'success');
                } else {
                    showNotification('Meta atualizada!', 'success');
                }
            }
        }

        function deleteGoal(id) {
            if (confirm('Tem certeza que deseja excluir esta meta?')) {
                appData.goals = appData.goals.filter(g => g.id !== id);
                saveData();
                updateGoalsStats();
                renderGoals();
                updateGoalsPreview();
                showNotification('Meta removida com sucesso!', 'success');
            }
        }

        // FUNÇÕES DE ORÇAMENTO
        function handleBudgetSubmit(e) {
            e.preventDefault();
            
            const category = document.getElementById('budgetCategory').value;
            const amount = parseCurrencyInput(document.getElementById('budgetAmount').value);
            const month = document.getElementById('budgetMonth').value;

            if (amount <= 0) {
                showNotification('O valor deve ser maior que zero!', 'error');
                return;
            }

            const existingBudgetIndex = appData.budgets.findIndex(b => b.category === category && b.month === month);
            
            if (existingBudgetIndex !== -1) {
                appData.budgets[existingBudgetIndex].amount = amount;
                showNotification('Orçamento atualizado com sucesso!', 'success');
            } else {
                const budget = {
                    id: Date.now(),
                    category: category,
                    amount: amount,
                    month: month
                };
                appData.budgets.push(budget);
                showNotification('Orçamento criado com sucesso!', 'success');
            }
            
            saveData();
            updateBudgetOverview();
            renderBudgetCategories();
            closeBudgetModal();
        }

        function deleteBudget(id) {
            if (confirm('Tem certeza que deseja excluir este orçamento?')) {
                appData.budgets = appData.budgets.filter(b => b.id !== id);
                saveData();
                updateBudgetOverview();
                renderBudgetCategories();
                showNotification('Orçamento removido com sucesso!', 'success');
            }
        }

        // FUNÇÕES DE INVESTIMENTO
        function handleInvestmentSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('investmentName').value.trim();
            const type = document.getElementById('investmentType').value;
            const amount = parseCurrencyInput(document.getElementById('investmentAmount').value);
            const currentValue = parseCurrencyInput(document.getElementById('investmentCurrentValue').value);
            const date = document.getElementById('investmentDate').value;

            if (amount <= 0) {
                showNotification('O valor investido deve ser maior que zero!', 'error');
                return;
            }

            if (currentValue < 0) {
                showNotification('O valor atual não pode ser negativo!', 'error');
                return;
            }

            const investment = {
                id: Date.now(),
                name: name,
                type: type,
                amount: amount,
                currentValue: currentValue,
                date: date
            };

            appData.investments.push(investment);
            saveData();
            updateInvestmentOverview();
            renderInvestments();
            closeInvestmentModal();
            
            showNotification('Investimento adicionado com sucesso!', 'success');
        }

        function deleteInvestment(id) {
            if (confirm('Tem certeza que deseja excluir este investimento?')) {
                appData.investments = appData.investments.filter(i => i.id !== id);
                saveData();
                updateInvestmentOverview();
                renderInvestments();
                showNotification('Investimento removido com sucesso!', 'success');
            }
        }

        function updateInvestment(id, newValue) {
            if (!newValue || newValue < 0) {
                showNotification('Digite um valor válido!', 'error');
                return;
            }

            const investment = appData.investments.find(i => i.id === id);
            if (investment) {
                investment.currentValue = newValue;
                document.getElementById(`investmentInput${id}`).value = '';
                saveData();
                updateInvestmentOverview();
                renderInvestments();
                showNotification('Investimento atualizado!', 'success');
            }
        }

        // FUNÇÕES DE ATUALIZAÇÃO DE DADOS
        function updateAllDisplays() {
            updateDashboard();
            updateTransactionStats();
            updateBudgetOverview();
            updateGoalsStats();
            updateInvestmentOverview();
            updateRecentTransactions();
            updateGoalsPreview();
            renderTransactions();
            renderBudgetCategories();
            renderGoals();
            renderInvestments();
            renderDetailedAnalysis();
            renderFinancialHealth();
            
            // Debt updates
            if (typeof renderDebts === 'function') renderDebts();
            if (typeof updateDebtStats === 'function') updateDebtStats();
        }

        function updateAllDropdowns() {
            updateCategoryFilters();
            updateTransactionCategories();
            updateBudgetCategories();
        }

        function updateDashboard() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const lastMonth = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 7);
            
            const monthlyIncome = appData.transactions
                .filter(t => t.type === 'income' && t.date.startsWith(currentMonth) && t.status !== 'pending')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const monthlyExpenses = appData.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonth) && t.status !== 'pending')
                .reduce((sum, t) => sum + t.amount, 0);

            const lastMonthIncome = appData.transactions
                .filter(t => t.type === 'income' && t.date.startsWith(lastMonth) && t.status !== 'pending')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const lastMonthExpenses = appData.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(lastMonth) && t.status !== 'pending')
                .reduce((sum, t) => sum + t.amount, 0);
                
            // Lógica solicitada: "so contabilizar o saldo o mes que for lançado renda"
            // Ignora despesas de meses onde não houve entrada de dinheiro (ex: dívidas antigas ou meses sem salário lançado)
            
            const transactionsByMonth = {};
            appData.transactions.forEach(t => {
                if (t.status === 'pending') return;
                const monthKey = t.date.slice(0, 7); // YYYY-MM
                if (!transactionsByMonth[monthKey]) {
                    transactionsByMonth[monthKey] = { income: 0, expense: 0 };
                }
                if (t.type === 'income') {
                    transactionsByMonth[monthKey].income += t.amount;
                } else {
                    transactionsByMonth[monthKey].expense += t.amount;
                }
            });

            let totalBalance = 0;
            Object.values(transactionsByMonth).forEach(monthData => {
                if (monthData.income > 0) {
                    totalBalance += (monthData.income - monthData.expense);
                }
            });
            
            let monthlySavings = monthlyIncome - monthlyExpenses;
            
            // Se não houver renda, não mostrar economia negativa
            if (monthlyIncome === 0 && monthlySavings < 0) {
                monthlySavings = 0;
            }
            const savingsRate = monthlyIncome > 0 ? (monthlySavings / monthlyIncome * 100) : 0;

            const incomeChange = lastMonthIncome > 0 ? ((monthlyIncome - lastMonthIncome) / lastMonthIncome * 100) : 0;
            const expenseChange = lastMonthExpenses > 0 ? ((monthlyExpenses - lastMonthExpenses) / lastMonthExpenses * 100) : 0;

            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('monthlyExpensesDash').textContent = formatCurrency(monthlyExpenses);
            document.getElementById('monthlySavingsDash').textContent = formatCurrency(monthlySavings);
            
            document.getElementById('incomeChange').textContent = `${incomeChange >= 0 ? '+' : ''}${incomeChange.toFixed(1)}%`;
            document.getElementById('expenseChange').textContent = `${expenseChange >= 0 ? '+' : ''}${expenseChange.toFixed(1)}%`;
            document.getElementById('savingsRate').textContent = `${savingsRate.toFixed(1)}%`;

            // Total Investments
            const totalInvestments = appData.investments ? appData.investments.reduce((sum, inv) => sum + (Number(inv.currentValue) || 0), 0) : 0;
            const totalInvestmentsEl = document.getElementById('totalInvestmentsDash');
            if (totalInvestmentsEl) {
                totalInvestmentsEl.textContent = formatCurrency(totalInvestments);
            }

            // Expense Ratio
            const expenseRatio = monthlyIncome > 0 ? (monthlyExpenses / monthlyIncome * 100) : 0;
            const expenseRatioEl = document.getElementById('expenseRatio');
            if (expenseRatioEl) {
                expenseRatioEl.textContent = `${expenseRatio.toFixed(1)}% da Receita`;
                // Color coding based on ratio
                expenseRatioEl.className = `text-xs font-bold mt-1 inline-block px-2 py-0.5 rounded-lg w-fit ${
                    expenseRatio > 90 ? 'bg-red-500/30 text-white' : 
                    expenseRatio > 70 ? 'bg-orange-500/30 text-white' : 
                    'bg-green-500/30 text-white'
                }`;
            }

            updateFinancialSuggestion(monthlyIncome, monthlyExpenses, totalBalance);
        }

        function updateFinancialSuggestion(income, expenses, balance) {
            const suggestionEl = document.getElementById('financialSuggestion');
            const iconEl = document.getElementById('suggestionIcon');
            const titleEl = document.getElementById('suggestionTitle');
            const textEl = document.getElementById('suggestionText');
            
            if (!suggestionEl) return;

            let type = 'success';
            let title = '';
            let message = '';
            let icon = '';

            const expenseRatio = income > 0 ? (expenses / income * 100) : 0;

            if (balance < 0) {
                type = 'danger';
                title = 'Atenção: Saldo Negativo';
                message = 'Seu saldo total está negativo. Priorize o pagamento de dívidas e evite novos gastos supérfluos até regularizar sua situação.';
                icon = 'fa-exclamation-triangle';
            } else if (expenseRatio > 90) {
                type = 'danger';
                title = 'Alerta de Gastos Excessivos';
                message = `Seus gastos representam ${expenseRatio.toFixed(1)}% da sua renda. Isso é muito arriscado. Tente cortar gastos não essenciais imediatamente.`;
                icon = 'fa-fire';
            } else if (expenseRatio > 70) {
                type = 'warning';
                title = 'Cuidado com o Orçamento';
                message = `Seus gastos estão em ${expenseRatio.toFixed(1)}% da renda. O ideal é manter abaixo de 70% para ter margem de segurança e investir.`;
                icon = 'fa-bell';
            } else if (expenseRatio > 50) {
                type = 'info';
                title = 'Saúde Financeira Estável';
                message = `Seus gastos estão controlados (${expenseRatio.toFixed(1)}%). Considere aumentar seus investimentos para acelerar seus objetivos.`;
                icon = 'fa-chart-line';
            } else {
                type = 'success';
                title = 'Excelente Gestão Financeira!';
                message = `Parabéns! Você gasta apenas ${expenseRatio.toFixed(1)}% do que ganha. Aproveite essa folga para maximizar seus investimentos.`;
                icon = 'fa-trophy';
            }

            // Update UI
            suggestionEl.className = `mb-8 p-4 rounded-2xl border-l-4 shadow-md transition-all duration-300 ${
                type === 'danger' ? 'bg-red-100 border-red-500 text-red-800 dark:bg-red-900/20 dark:text-red-200' :
                type === 'warning' ? 'bg-orange-100 border-orange-500 text-orange-800 dark:bg-orange-900/20 dark:text-orange-200' :
                type === 'info' ? 'bg-blue-100 border-blue-500 text-blue-800 dark:bg-blue-900/20 dark:text-blue-200' :
                'bg-green-100 border-green-500 text-green-800 dark:bg-green-900/20 dark:text-green-200'
            }`;

            iconEl.className = `fas ${icon} text-xl`;
            titleEl.textContent = title;
            textEl.textContent = message;
            
            suggestionEl.classList.remove('hidden');
        }

        function updateTransactionStats() {
            const totalTransactions = appData.transactions.length;
            const maxIncome = Math.max(...appData.transactions.filter(t => t.type === 'income' && t.status !== 'pending').map(t => t.amount), 0);
            const maxExpense = Math.max(...appData.transactions.filter(t => t.type === 'expense' && t.status !== 'pending').map(t => t.amount), 0);

            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('maxIncome').textContent = formatCurrency(maxIncome);
            document.getElementById('maxExpense').textContent = formatCurrency(maxExpense);
        }

        function updateBudgetOverview() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const totalBudget = appData.budgets
                .filter(b => b.month === currentMonth)
                .reduce((sum, b) => sum + b.amount, 0);
            
            const totalSpent = appData.budgets
                .filter(b => b.month === currentMonth)
                .reduce((sum, b) => {
                    const spent = appData.transactions
                        .filter(t => t.type === 'expense' && t.category === b.category && t.date.startsWith(currentMonth) && t.status !== 'pending')
                        .reduce((categorySum, t) => categorySum + t.amount, 0);
                    return sum + spent;
                }, 0);
            
            const budgetRemaining = totalBudget - totalSpent;

            document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
            document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
            document.getElementById('budgetRemaining').textContent = formatCurrency(budgetRemaining);
        }

        function updateGoalsStats() {
            const totalGoals = appData.goals.length;
            const completedGoals = appData.goals.filter(g => g.current >= g.target).length;
            const activeGoals = totalGoals - completedGoals;
            
            const averageProgress = totalGoals > 0 
                ? appData.goals.reduce((sum, goal) => sum + (Math.min(goal.current / goal.target, 1) * 100), 0) / totalGoals
                : 0;

            document.getElementById('totalGoals').textContent = totalGoals;
            document.getElementById('completedGoals').textContent = completedGoals;
            document.getElementById('activeGoals').textContent = activeGoals;
            document.getElementById('averageProgress').textContent = `${averageProgress.toFixed(1)}%`;
        }

        function updateInvestmentOverview() {
            const totalInvested = appData.investments.reduce((sum, i) => sum + i.amount, 0);
            const currentValue = appData.investments.reduce((sum, i) => sum + i.currentValue, 0);
            const totalReturn = currentValue - totalInvested;
            const returnPercentage = totalInvested > 0 ? (totalReturn / totalInvested * 100) : 0;

            document.getElementById('totalInvested').textContent = formatCurrency(totalInvested);
            document.getElementById('currentValue').textContent = formatCurrency(currentValue);
            document.getElementById('totalReturn').textContent = formatCurrency(totalReturn);
            document.getElementById('returnPercentage').textContent = `${returnPercentage >= 0 ? '+' : ''}${returnPercentage.toFixed(2)}%`;
        }

        // FUNÇÕES DE RENDERIZAÇÃO
        function renderTransactions() {
            const container = document.getElementById('transactionsList');
            const countElement = document.getElementById('transactionCount');
            const typeFilter = document.getElementById('filterType').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            const monthFilter = document.getElementById('filterMonth').value;

            let filteredTransactions = [...appData.transactions];

            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }

            if (categoryFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.category === categoryFilter);
            }

            if (monthFilter) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.date.startsWith(monthFilter)
                );
            }

            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            countElement.textContent = `${filteredTransactions.length} transação${filteredTransactions.length !== 1 ? 'ões' : ''}`;

            if (filteredTransactions.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center text-gray-500 dark:text-gray-400">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                            <i class="fas fa-search text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Nenhuma transação encontrada</h3>
                        <p class="text-sm">Tente ajustar os filtros ou adicione uma nova transação</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredTransactions.map(transaction => `
                <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all duration-200 group">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center ${
                                transaction.type === 'income' 
                                ? 'bg-success/20 text-success' 
                                : 'bg-danger/20 text-danger'
                            }">
                                <i class="fas ${transaction.type === 'income' ? 'fa-arrow-up' : 'fa-arrow-down'} text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800 dark:text-white">${transaction.description}</h4>
                                <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-lg">${transaction.category}</span>
                                    <span>•</span>
                                    <span>${formatDate(transaction.date)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="toggleTransactionStatus(${transaction.id})" 
                                    class="p-2 rounded-lg transition-colors ${transaction.status === 'pending' ? 'text-warning hover:bg-warning/10' : 'text-success hover:bg-success/10'}"
                                    title="${transaction.status === 'pending' ? 'Marcar como Pago' : 'Marcar como Pendente'}">
                                <i class="fas ${transaction.status === 'pending' ? 'fa-clock' : 'fa-check-circle'}"></i>
                            </button>
                            <span class="font-bold text-lg ${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                                ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                            </span>
                            <button onclick="deleteTransaction(${transaction.id})" 
                                    class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-danger transition-all p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderBudgetCategories() {
            const container = document.getElementById('budgetCategories');
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const currentBudgets = appData.budgets.filter(b => b.month === currentMonth);
            
            if (currentBudgets.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                            <i class="fas fa-calculator text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Nenhum orçamento definido</h3>
                        <p class="text-sm mb-4">Defina orçamentos para controlar seus gastos por categoria</p>
                        <button onclick="openBudgetModal()" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>Criar Orçamento
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentBudgets.map(budget => {
                const spent = appData.transactions
                    .filter(t => t.type === 'expense' && t.category === budget.category && t.date.startsWith(currentMonth))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const remaining = budget.amount - spent;
                const percentage = Math.min((spent / budget.amount) * 100, 100);
                const status = percentage >= 100 ? 'over' : percentage >= 80 ? 'warning' : 'good';
                
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-6 ${
                        status === 'over' ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' :
                        status === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800' :
                        'bg-gray-50 dark:bg-gray-700/50'
                    }">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white">${budget.category}</h4>
                            <button onclick="deleteBudget(${budget.id})" class="text-gray-400 hover:text-danger transition-colors p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Orçamento</p>
                                <p class="font-bold text-gray-800 dark:text-white">${formatCurrency(budget.amount)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Gasto</p>
                                <p class="font-bold ${status === 'over' ? 'text-danger' : 'text-gray-800 dark:text-white'}">${formatCurrency(spent)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Restante</p>
                                <p class="font-bold ${remaining < 0 ? 'text-danger' : 'text-success'}">${formatCurrency(Math.abs(remaining))}</p>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Progresso</span>
                                <span class="text-sm font-bold ${
                                    status === 'over' ? 'text-danger' :
                                    status === 'warning' ? 'text-warning' : 'text-success'
                                }">${percentage.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3 overflow-hidden">
                                <div class="h-3 rounded-full transition-all duration-500 ${
                                    status === 'over' ? 'bg-gradient-to-r from-danger to-red-600' :
                                    status === 'warning' ? 'bg-gradient-to-r from-warning to-yellow-600' :
                                    'bg-gradient-to-r from-success to-emerald-600'
                                }" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                        </div>
                        
                        ${status === 'over' ? `
                            <div class="mt-3 p-3 bg-danger/10 border border-danger/20 rounded-lg">
                                <p class="text-sm text-danger font-medium">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    Orçamento ultrapassado em ${formatCurrency(spent - budget.amount)}
                                </p>
                            </div>
                        ` : status === 'warning' ? `
                            <div class="mt-3 p-3 bg-warning/10 border border-warning/20 rounded-lg">
                                <p class="text-sm text-warning font-medium">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    Próximo do limite do orçamento
                                </p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // DEBT FUNCTIONS
        function openDebtModal() {
            document.getElementById('debtModal').classList.remove('hidden');
            document.getElementById('debtName').focus();
        }

        function closeDebtModal() {
            document.getElementById('debtModal').classList.add('hidden');
            document.getElementById('debtForm').reset();
        }

        function calculateDebtInfo() {
            const originalAmount = parseCurrencyInput(document.getElementById('debtOriginalAmount').value);
            const installments = parseInt(document.getElementById('debtTotalInstallments').value) || 0;
            const installmentValue = parseCurrencyInput(document.getElementById('debtInstallmentValue').value);
            
            const infoDiv = document.getElementById('debtCalculationInfo');
            
            if (installments > 0 && installmentValue > 0) {
                const totalFinal = installments * installmentValue;
                const interest = totalFinal - originalAmount;
                
                document.getElementById('calcTotalDebt').textContent = formatCurrency(totalFinal);
                
                const interestEl = document.getElementById('calcInterest');
                interestEl.textContent = formatCurrency(interest);
                
                if (interest > 0) {
                    interestEl.classList.remove('text-success');
                    interestEl.classList.add('text-danger');
                    interestEl.textContent = `+ ${formatCurrency(interest)} (${((interest/originalAmount)*100).toFixed(1)}%)`;
                } else if (interest < 0) {
                    interestEl.classList.remove('text-danger');
                    interestEl.classList.add('text-success'); // Desconto?
                    interestEl.textContent = formatCurrency(interest);
                } else {
                    interestEl.classList.remove('text-danger');
                    interestEl.classList.add('text-gray-500');
                    interestEl.textContent = 'Sem juros';
                }
                
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        function handleDebtSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('debtName').value;
            const originalAmount = parseCurrencyInput(document.getElementById('debtOriginalAmount').value);
            const totalInstallments = parseInt(document.getElementById('debtTotalInstallments').value);
            const installmentValue = parseCurrencyInput(document.getElementById('debtInstallmentValue').value);
            const paidInstallments = parseInt(document.getElementById('debtPaidInstallments').value) || 0;
            const dueDateStr = document.getElementById('debtDueDate').value;
            
            if (!name || isNaN(originalAmount) || isNaN(totalInstallments) || isNaN(installmentValue) || !dueDateStr) {
                showNotification('Preencha todos os campos obrigatórios!', 'error');
                return;
            }
            
            const totalAmount = totalInstallments * installmentValue;
            const debtId = Date.now();
            
            const debt = {
                id: debtId,
                name,
                originalAmount, // Valor à vista
                totalAmount, // Valor final (com juros)
                totalInstallments,
                paidInstallments,
                paidAmount: installmentValue * paidInstallments,
                installmentValue: installmentValue,
                dueDate: dueDateStr,
                date: new Date().toISOString()
            };
            
            if (!appData.debts) appData.debts = [];
            appData.debts.push(debt);

            // GERAR TRANSAÇÕES AUTOMÁTICAS
            // Data base para cálculo (dia do vencimento)
            // Divide ano, mes, dia para evitar problemas de fuso horário com Date()
            const [y, m, d] = dueDateStr.split('-').map(Number);
            
            for (let i = 0; i < totalInstallments; i++) {
                // Se a parcela já foi paga (marcada no form), gera como paid
                // Se não, gera como pending
                // A data deve avançar 1 mês a cada iteração
                
                // Correção de Data: Garante que o dia seja respeitado e não pule meses (ex: 31/01 -> 28/02)
                let targetYear = y;
                let targetMonth = m - 1 + i; // m é 1-based no split, 0-based no Date
                
                // Ajusta ano se passar de dezembro
                targetYear += Math.floor(targetMonth / 12);
                targetMonth = targetMonth % 12;

                // Cria data no dia 1 para evitar overflow de dias (ex: 31/02)
                const instDate = new Date(targetYear, targetMonth, 1);
                
                // Tenta setar o dia original. Se o mês não tiver esse dia (ex: 30/02), pega o último dia do mês.
                const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
                instDate.setDate(Math.min(d, daysInMonth));

                const dateString = instDate.toISOString().split('T')[0];
                
                // Verifica status
                const status = i < paidInstallments ? 'paid' : 'pending';
                
                const transaction = {
                    id: Date.now() + i + Math.random(),
                    description: `${name} (${i+1}/${totalInstallments})`,
                    amount: installmentValue,
                    type: 'expense',
                    category: 'Dívidas',
                    date: dateString,
                    status: status,
                    debtId: debtId
                };
                
                appData.transactions.unshift(transaction);
            }

            saveData();
            
            closeDebtModal();
            updateDebtStats();
            renderDebts();
            updateAllDisplays(); // Para atualizar lista de transações
            showNotification('Dívida e parcelas geradas com sucesso!', 'success');
        }

        function deleteDebt(id) {
            if (confirm('Tem certeza que deseja excluir esta dívida?')) {
                // Remove transactions linked to this debt
                const initialCount = appData.transactions.length;
                appData.transactions = appData.transactions.filter(t => t.debtId !== id && t.linkedDebtId !== id);
                const removedCount = initialCount - appData.transactions.length;
                console.log(`Removed ${removedCount} linked transactions for debt ${id}`);

                appData.debts = appData.debts.filter(d => d.id !== id);
                saveData();
                updateDebtStats();
                renderDebts();
                updateAllDisplays(); // Update transaction list and charts
                showNotification('Dívida e transações vinculadas excluídas com sucesso!', 'success');
            }
        }

        function updateDebtStats() {
            if (!appData.debts) appData.debts = [];
            const totalDebt = appData.debts.reduce((sum, d) => sum + d.totalAmount, 0);
            const totalPaid = appData.debts.reduce((sum, d) => sum + d.paidAmount, 0);
            
            const nextInstallment = appData.debts.reduce((sum, d) => {
                if (d.paidInstallments < d.totalInstallments) {
                    return sum + (d.totalAmount / d.totalInstallments);
                }
                return sum;
            }, 0);
            
            const totalDebtEl = document.getElementById('totalDebtAmount');
            if (totalDebtEl) totalDebtEl.textContent = formatCurrency(totalDebt - totalPaid);
            
            const totalPaidEl = document.getElementById('totalDebtPaid');
            if (totalPaidEl) totalPaidEl.textContent = formatCurrency(totalPaid);
            
            const nextInstallmentEl = document.getElementById('nextDebtInstallment');
            if (nextInstallmentEl) nextInstallmentEl.textContent = formatCurrency(nextInstallment);
        }

        function renderDebts() {
            const container = document.getElementById('debtsList');
            if (!container) return;
            
            if (!appData.debts || appData.debts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                            <i class="fas fa-credit-card text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Nenhuma dívida cadastrada</h3>
                        <p class="text-sm mb-4">Cadastre seus cartões e financiamentos para controle</p>
                        <button onclick="openDebtModal()" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>Nova Dívida
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.debts.map(debt => {
                const progress = (debt.paidInstallments / debt.totalInstallments) * 100;
                const remainingAmount = debt.totalAmount - debt.paidAmount;
                const installmentValue = debt.installmentValue || (debt.totalAmount / debt.totalInstallments);
                
                // Calcula Juros
                const interest = debt.originalAmount ? (debt.totalAmount - debt.originalAmount) : 0;
                const hasInterest = interest > 0.01;

                // Data de vencimento (dia)
                let dueDay = 'N/A';
                if (debt.dueDate) {
                    const d = new Date(debt.dueDate); // This might be UTC/Local dependent but usually safe for just day extraction if not crossing midnight too much
                    // Actually, simpler:
                    dueDay = debt.dueDate.split('-')[2];
                }

                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">${debt.name}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    ${debt.paidInstallments}/${debt.totalInstallments} Parcelas
                                    ${debt.dueDate ? `<span class="ml-2 text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded">Dia ${dueDay}</span>` : ''}
                                </p>
                            </div>
                            <button onclick="deleteDebt(${debt.id})" class="text-gray-400 hover:text-danger transition-colors p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Progresso</span>
                                <span class="text-sm font-bold text-primary">${progress.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div class="bg-gradient-to-r from-primary to-secondary h-2.5 rounded-full transition-all duration-500" 
                                     style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4 bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Valor da Parcela</p>
                                <p class="font-bold text-gray-800 dark:text-white">${formatCurrency(installmentValue)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Restante</p>
                                <p class="font-bold text-danger">${formatCurrency(remainingAmount)}</p>
                            </div>
                            ${hasInterest ? `
                            <div class="col-span-2 pt-2 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center">
                                <p class="text-xs text-gray-500 dark:text-gray-400">Juros Totais</p>
                                <p class="text-xs font-bold text-danger">+ ${formatCurrency(interest)}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderGoals() {
            const container = document.getElementById('goalsList');

            if (appData.goals.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16 text-gray-500 dark:text-gray-400">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-warning/20 to-yellow-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-target text-4xl text-warning"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">Nenhuma meta definida</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Defina suas metas financeiras e acompanhe seu progresso!</p>
                        <button onclick="openGoalModal()" class="bg-gradient-to-r from-warning to-yellow-600 hover:from-warning/90 hover:to-yellow-600/90 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>Criar Primeira Meta
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = appData.goals.map(goal => {
                const progress = Math.min((goal.current / goal.target) * 100, 100);
                const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                const isCompleted = goal.current >= goal.target;
                const isOverdue = daysLeft < 0;
                
                // Monthly deposit calculation
                const remaining = Math.max(0, goal.target - goal.current);
                let monthlyDepositHtml = '';
                
                if (!isCompleted && !isOverdue && remaining > 0) {
                    // Use a minimum of 1 month to avoid division by zero or huge numbers for short periods
                    const months = Math.max(1, daysLeft / 30); 
                    const monthlyValue = remaining / months;
                    
                    monthlyDepositHtml = `
                        <p class="text-sm font-medium text-primary dark:text-primary-light mb-1">
                            <i class="fas fa-coins mr-1"></i>
                            Aporte sugerido: <strong>${formatCurrency(monthlyValue)}</strong>/mês
                        </p>
                    `;
                }
                
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-2xl hover:scale-105">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">${goal.name}</h3>
                                ${isCompleted ? 
                                    '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-success/20 text-success"><i class="fas fa-check mr-1"></i>Concluída</span>' :
                                    isOverdue ? 
                                        '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-danger/20 text-danger"><i class="fas fa-exclamation mr-1"></i>Atrasada</span>' :
                                        `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-primary/20 text-primary"><i class="fas fa-clock mr-1"></i>Em andamento</span>`
                                }
                            </div>
                            <button onclick="deleteGoal(${goal.id})" 
                                    class="text-gray-400 hover:text-danger transition-colors p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Progresso</span>
                                <span class="text-sm font-bold text-gray-800 dark:text-white">${progress.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                                <div class="h-3 rounded-full transition-all duration-500 ease-out ${
                                    isCompleted ? 'bg-gradient-to-r from-success to-emerald-600' :
                                    progress > 75 ? 'bg-gradient-to-r from-warning to-yellow-600' :
                                    'bg-gradient-to-r from-primary to-secondary'
                                }" 
                                     style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Atual</p>
                                <p class="font-bold text-lg text-primary">${formatCurrency(goal.current)}</p>
                            </div>
                            <div class="text-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Meta</p>
                                <p class="font-bold text-lg text-gray-800 dark:text-white">${formatCurrency(goal.target)}</p>
                            </div>
                        </div>
                        
                        <div class="mb-4 text-center">
                            ${monthlyDepositHtml}
                            <p class="text-sm ${isOverdue ? 'text-danger' : 'text-gray-600 dark:text-gray-400'}">
                                <i class="fas fa-calendar mr-1"></i>
                                ${isOverdue ? `Atrasada há ${Math.abs(daysLeft)} dias` : 
                                  daysLeft === 0 ? 'Vence hoje' :
                                  daysLeft === 1 ? 'Vence amanhã' :
                                  `${daysLeft} dias restantes`}
                            </p>
                        </div>
                        
                        ${!isCompleted ? `
                            <div class="flex gap-2">
                                <input type="text" placeholder="Valor" oninput="formatCurrencyInput(this)"
                                       class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-xl dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                       id="goalInput${goal.id}">
                                <button onclick="updateGoal(${goal.id}, parseCurrencyInput(document.getElementById('goalInput${goal.id}').value) || 0)"
                                        class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        ` : `
                            <div class="text-center py-3">
                                <i class="fas fa-trophy text-3xl text-warning mb-2"></i>
                                <p class="text-sm font-semibold text-success">Meta alcançada! 🎉</p>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function renderInvestments() {
            const container = document.getElementById('investmentsList');

            // Render Allocation Chart whenever investments are rendered
            renderAllocationChart();

            if (appData.investments.length === 0) {
                // If no investments, clear chart if exists
                if (charts.allocation) {
                    charts.allocation.destroy();
                    charts.allocation = null;
                }
                
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-accent/20 to-emerald-500/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-chart-pie text-3xl text-accent"></i>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Nenhum investimento cadastrado</h3>
                        <p class="text-sm mb-4">Adicione seus investimentos para acompanhar o desempenho da sua carteira</p>
                        <button onclick="openInvestmentModal()" class="bg-gradient-to-r from-accent to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>Adicionar Investimento
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = appData.investments.map(investment => {
                const returnValue = investment.currentValue - investment.amount;
                const returnPercentage = investment.amount > 0 ? (returnValue / investment.amount * 100) : 0;
                const isPositive = returnValue >= 0;
                
                const typeColors = {
                    'renda-fixa': 'blue',
                    'renda-variavel': 'purple',
                    'fundo': 'green',
                    'cripto': 'yellow',
                    'imovel': 'red',
                    'outros': 'gray'
                };
                
                const color = typeColors[investment.type] || 'gray';
                
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-6 hover:shadow-lg transition-all duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-${color}-100 dark:bg-${color}-900/20">
                                    <i class="fas fa-chart-line text-${color}-600 dark:text-${color}-400"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 dark:text-white">${investment.name}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 capitalize">${investment.type.replace('-', ' ')}</p>
                                </div>
                            </div>
                            <button onclick="deleteInvestment(${investment.id})" class="text-gray-400 hover:text-danger transition-colors p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Valor Investido</p>
                                <p class="font-bold text-gray-800 dark:text-white">${formatCurrency(investment.amount)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Valor Atual</p>
                                <p class="font-bold text-gray-800 dark:text-white">${formatCurrency(investment.currentValue)}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Rendimento</p>
                                <p class="font-bold ${isPositive ? 'text-success' : 'text-danger'}">
                                    ${isPositive ? '+' : ''}${formatCurrency(returnValue)}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Rentabilidade</p>
                                <p class="font-bold ${isPositive ? 'text-success' : 'text-danger'}">
                                    ${isPositive ? '+' : ''}${returnPercentage.toFixed(2)}%
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                <i class="fas fa-calendar mr-1"></i>
                                ${formatDate(investment.date)}
                            </div>
                            <div class="flex gap-2">
                                <input type="text" placeholder="Novo valor" oninput="formatCurrencyInput(this)"
                                       class="w-24 p-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                       id="investmentInput${investment.id}">
                                <button onclick="updateInvestment(${investment.id}, parseCurrencyInput(document.getElementById('investmentInput${investment.id}').value) || 0)"
                                        class="bg-gradient-to-r from-accent to-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-300 transform hover:scale-105">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAllocationChart() {
            const ctx = document.getElementById('allocationChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (charts.allocation) {
                charts.allocation.destroy();
                charts.allocation = null;
            }

            // Group data
            const allocation = {};
            let totalValue = 0;

            appData.investments.forEach(inv => {
                if (!allocation[inv.type]) {
                    allocation[inv.type] = 0;
                }
                allocation[inv.type] += inv.currentValue;
                totalValue += inv.currentValue;
            });

            if (totalValue === 0) return;

            const labels = Object.keys(allocation).map(type => {
                const map = {
                    'renda-fixa': 'Renda Fixa',
                    'renda-variavel': 'Ações',
                    'fundo': 'FIIs',
                    'cripto': 'Cripto',
                    'imovel': 'Imóveis',
                    'outros': 'Outros'
                };
                return map[type] || type;
            });

            const data = Object.values(allocation);
            const colors = Object.keys(allocation).map(type => {
                const map = {
                    'renda-fixa': '#3b82f6', // blue-500
                    'renda-variavel': '#a855f7', // purple-500
                    'fundo': '#22c55e', // green-500
                    'cripto': '#eab308', // yellow-500
                    'imovel': '#ef4444', // red-500
                    'outros': '#9ca3af' // gray-400
                };
                return map[type] || '#9ca3af';
            });

            charts.allocation = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563',
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = (value / totalValue * 100).toFixed(1) + '%';
                                    return ` ${context.label}: ${formatCurrency(value)} (${percentage})`;
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            const recentTransactions = appData.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-inbox text-3xl mb-3"></i>
                        <p class="text-sm">Nenhuma transação recente</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentTransactions.map(transaction => `
                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center ${
                        transaction.type === 'income' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'
                    }">
                        <i class="fas ${transaction.type === 'income' ? 'fa-arrow-up' : 'fa-arrow-down'} text-sm"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-800 dark:text-white truncate">${transaction.description}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${transaction.category} • ${formatDate(transaction.date)}</p>
                    </div>
                    <span class="font-semibold text-sm ${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                        ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                    </span>
                </div>
            `).join('');
        }

        function updateGoalsPreview() {
            const container = document.getElementById('goalsPreview');
            const activeGoals = appData.goals
                .filter(g => g.current < g.target)
                .slice(0, 3);

            if (activeGoals.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-target text-3xl mb-3"></i>
                        <p class="text-sm">Nenhuma meta ativa</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = activeGoals.map(goal => {
                const progress = (goal.current / goal.target) * 100;
                const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-medium text-gray-800 dark:text-white">${goal.name}</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${
                                daysLeft < 30 ? 'bg-warning/20 text-warning' : 'bg-primary/20 text-primary'
                            }">
                                ${daysLeft}d
                            </span>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600 dark:text-gray-400">${formatCurrency(goal.current)}</span>
                                <span class="text-gray-600 dark:text-gray-400">${formatCurrency(goal.target)}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-primary to-secondary h-2 rounded-full transition-all duration-500" 
                                     style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${progress.toFixed(1)}% concluído</p>
                    </div>
                `;
            }).join('');
        }

        function renderDetailedAnalysis() {
            const container = document.getElementById('detailedAnalysis');
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const monthlyIncome = appData.transactions
                .filter(t => t.type === 'income' && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.amount, 0);
                
            const monthlyExpenses = appData.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.amount, 0);

            const savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpenses) / monthlyIncome * 100) : 0;
            
            const categoryTotals = {};
            appData.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonth))
                .forEach(t => {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                });
            
            const topCategory = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a)[0];
            
            const totalGoalProgress = appData.goals.length > 0 
                ? appData.goals.reduce((sum, goal) => sum + (Math.min(goal.current / goal.target, 1)), 0) / appData.goals.length * 100
                : 0;

            container.innerHTML = `
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-2xl border border-blue-200 dark:border-blue-800">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-percentage text-blue-500 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white">Taxa de Poupança</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Percentual economizado</p>
                        </div>
                    </div>
                    <div class="text-3xl font-bold ${savingsRate >= 20 ? 'text-success' : savingsRate >= 10 ? 'text-warning' : 'text-danger'} mb-2">
                        ${savingsRate.toFixed(1)}%
                    </div>
                    <div class="text-sm ${savingsRate >= 20 ? 'text-success' : savingsRate >= 10 ? 'text-warning' : 'text-danger'}">
                        ${savingsRate >= 20 ? 'Excelente!' : savingsRate >= 10 ? 'Bom progresso' : 'Pode melhorar'}
                    </div>
                </div>

                <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-6 rounded-2xl border border-purple-200 dark:border-purple-800">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-chart-pie text-purple-500 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white">Maior Gasto</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Categoria com mais despesas</p>
                        </div>
                    </div>
                    <div class="text-lg font-bold text-gray-800 dark:text-white mb-1">
                        ${topCategory ? topCategory[0] : 'N/A'}
                    </div>
                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">
                        ${topCategory ? formatCurrency(topCategory[1]) : 'R$ 0,00'}
                    </div>
                </div>

                <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-6 rounded-2xl border border-green-200 dark:border-green-800">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-bullseye text-green-500 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white">Progresso das Metas</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Média geral</p>
                        </div>
                    </div>
                    <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-2">
                        ${totalGoalProgress.toFixed(1)}%
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 h-2 rounded-full transition-all duration-500" 
                             style="width: ${Math.min(totalGoalProgress, 100)}%"></div>
                    </div>
                </div>
            `;
        }

        function renderFinancialHealth() {
            const container = document.getElementById('financialHealth');
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            const monthlyIncome = appData.transactions
                .filter(t => t.type === 'income' && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.amount, 0);
                
            const monthlyExpenses = appData.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.amount, 0);

            const totalBalance = appData.transactions
                .reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);

            const savingsRate = monthlyIncome > 0 ? ((monthlyIncome - monthlyExpenses) / monthlyIncome * 100) : 0;
            const emergencyFundMonths = monthlyExpenses > 0 ? (totalBalance / monthlyExpenses) : 0;
            
            let healthScore = 0;
            if (savingsRate >= 20) healthScore += 30;
            else if (savingsRate >= 10) healthScore += 20;
            else if (savingsRate >= 5) healthScore += 10;

            if (emergencyFundMonths >= 6) healthScore += 30;
            else if (emergencyFundMonths >= 3) healthScore += 20;
            else if (emergencyFundMonths >= 1) healthScore += 10;

            if (totalBalance > 0) healthScore += 20;
            
            const completedGoals = appData.goals.filter(g => g.current >= g.target).length;
            if (completedGoals > 0) healthScore += 20;

            let healthLevel = 'Crítica';
            let healthColor = 'danger';
            if (healthScore >= 80) {
                healthLevel = 'Excelente';
                healthColor = 'success';
            } else if (healthScore >= 60) {
                healthLevel = 'Boa';
                healthColor = 'warning';
            } else if (healthScore >= 40) {
                healthLevel = 'Regular';
                healthColor = 'warning';
            }

            container.innerHTML = `
                <div class="text-center">
                    <div class="relative w-32 h-32 mx-auto mb-6">
                        <svg class="progress-ring w-32 h-32" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" class="text-gray-200 dark:text-gray-700"></circle>
                            <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" 
                                    class="text-${healthColor} transition-all duration-1000"
                                    style="stroke-dasharray: 283; stroke-dashoffset: ${283 - (healthScore * 2.83)};">
                            </circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-${healthColor}">${healthScore}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Score</div>
                            </div>
                        </div>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Saúde Financeira</h4>
                    <p class="text-lg font-semibold text-${healthColor} mb-4">${healthLevel}</p>
                    
                    <div class="space-y-3 text-left">
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Taxa de Poupança</span>
                            <span class="font-semibold ${savingsRate >= 20 ? 'text-success' : savingsRate >= 10 ? 'text-warning' : 'text-danger'}">
                                ${savingsRate.toFixed(1)}%
                            </span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Reserva de Emergência</span>
                            <span class="font-semibold ${emergencyFundMonths >= 6 ? 'text-success' : emergencyFundMonths >= 3 ? 'text-warning' : 'text-danger'}">
                                ${emergencyFundMonths.toFixed(1)} meses
                            </span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Patrimônio Líquido</span>
                            <span class="font-semibold ${totalBalance > 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(totalBalance)}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Recomendações</h4>
                    <div class="space-y-3">
                        ${savingsRate < 10 ? `
                            <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-red-800 dark:text-red-200">Aumentar Taxa de Poupança</h5>
                                        <p class="text-sm text-red-600 dark:text-red-300">Tente economizar pelo menos 10% da sua renda mensal.</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${emergencyFundMonths < 6 ? `
                            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-shield-alt text-yellow-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-yellow-800 dark:text-yellow-200">Reserva de Emergência</h5>
                                        <p class="text-sm text-yellow-600 dark:text-yellow-300">Procure ter pelo menos 6 meses de gastos guardados para emergências.</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${appData.goals.length === 0 ? `
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-target text-blue-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-blue-800 dark:text-blue-200">Definir Metas</h5>
                                        <p class="text-sm text-blue-600 dark:text-blue-300">Estabeleça metas financeiras claras para manter o foco nos seus objetivos.</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${appData.budgets.length === 0 ? `
                            <div class="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-calculator text-green-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-green-800 dark:text-green-200">Controle Orçamentário</h5>
                                        <p class="text-sm text-green-600 dark:text-green-300">Crie orçamentos por categoria para melhor controle dos gastos.</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // FUNÇÕES DE DROPDOWN
        function updateTransactionCategories() {
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '';
            
            appData.categories[currentTransactionType].forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        function updateBudgetCategories() {
            const select = document.getElementById('budgetCategory');
            select.innerHTML = '';
            
            appData.categories.expense.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        function updateCategoryFilters() {
            const select = document.getElementById('filterCategory');
            select.innerHTML = '<option value="">Todas as categorias</option>';
            
            const allCategories = [...appData.categories.income, ...appData.categories.expense];
            const uniqueCategories = [...new Set(allCategories)];
            
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        // FUNÇÕES DE FILTRO
        function applyFilters() {
            renderTransactions();
        }

        function clearFilters() {
            document.getElementById('filterType').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);
            renderTransactions();
        }

        // FUNÇÕES DE GRÁFICOS
        function initializeCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#E5E7EB' : '#374151';
            const gridColor = isDark ? '#374151' : '#E5E7EB';

            // Destruir gráficos existentes antes de criar novos
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};

            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = textColor;

            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart');
            if (cashFlowCtx) {
                charts.cashFlow = new Chart(cashFlowCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Receitas',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#10B981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            fill: true
                        }, {
                            label: 'Despesas',
                            data: [],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#EF4444',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { 
                                    color: textColor,
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: isDark ? '#1F2937' : '#FFFFFF',
                                titleColor: textColor,
                                bodyColor: textColor,
                                borderColor: gridColor,
                                borderWidth: 1,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { 
                                    color: gridColor,
                                    borderColor: gridColor
                                }
                            },
                            y: {
                                ticks: { 
                                    color: textColor,
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                },
                                grid: { 
                                    color: gridColor,
                                    borderColor: gridColor
                                }
                            }
                        }
                    }
                });
            }

            // Expenses Chart
            const expensesCtx = document.getElementById('expensesChart');
            if (expensesCtx) {
                charts.expenses = new Chart(expensesCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#5D5CDE', '#818CF8', '#06D6A0', '#EF4444', 
                                '#F59E0B', '#10B981', '#8B5CF6', '#F97316',
                                '#EC4899', '#14B8A6'
                            ],
                            borderWidth: 0,
                            hoverBorderWidth: 3,
                            hoverBorderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: textColor,
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: isDark ? '#1F2937' : '#FFFFFF',
                                titleColor: textColor,
                                bodyColor: textColor,
                                borderColor: gridColor,
                                borderWidth: 1,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return context.label + ': ' + formatCurrency(context.raw) + ` (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateCharts();
        }

        function updateCharts() {
            updateCashFlowChart();
            updateExpensesChart();
        }

        function updateCashFlowChart() {
            if (!charts.cashFlow) return;

            const last6Months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = date.toISOString().slice(0, 7);
                
                last6Months.push(date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }));
                
                const monthIncome = appData.transactions
                    .filter(t => t.type === 'income' && t.date.startsWith(monthKey) && t.status !== 'pending')
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                const monthExpenses = appData.transactions
                    .filter(t => t.type === 'expense' && t.date.startsWith(monthKey) && t.status !== 'pending')
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                incomeData.push(monthIncome);
                expenseData.push(monthExpenses);
            }

            charts.cashFlow.data.labels = last6Months;
            charts.cashFlow.data.datasets[0].data = incomeData;
            charts.cashFlow.data.datasets[1].data = expenseData;
            charts.cashFlow.update('none');
        }

        function updateExpensesChart() {
            if (!charts.expenses) return;

            const currentMonth = new Date().toISOString().slice(0, 7);
            const categoryTotals = {};
            appData.transactions
                .filter(t => t.type === 'expense' && t.date.startsWith(currentMonth) && t.status !== 'pending')
                .forEach(t => {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                });

            charts.expenses.data.labels = Object.keys(categoryTotals);
            charts.expenses.data.datasets[0].data = Object.values(categoryTotals);
            charts.expenses.update('none');
        }

        function changeCashFlowPeriod(period) {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-primary/20', 'text-primary');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-600', 'dark:text-gray-300');
            });
            
            event.target.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-600', 'dark:text-gray-300');
            event.target.classList.add('active', 'bg-primary/20', 'text-primary');
            
            if (period === '1y') {
                updateCashFlowChart12Months();
            } else {
                updateCashFlowChart();
            }
        }

        function updateCashFlowChart12Months() {
            if (!charts.cashFlow) return;

            const last12Months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = date.toISOString().slice(0, 7);
                
                last12Months.push(date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                
                const monthIncome = appData.transactions
                    .filter(t => t.type === 'income' && t.date.startsWith(monthKey) && t.status !== 'pending')
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                const monthExpenses = appData.transactions
                    .filter(t => t.type === 'expense' && t.date.startsWith(monthKey) && t.status !== 'pending')
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                incomeData.push(monthIncome);
                expenseData.push(monthExpenses);
            }

            charts.cashFlow.data.labels = last12Months;
            charts.cashFlow.data.datasets[0].data = incomeData;
            charts.cashFlow.data.datasets[1].data = expenseData;
            charts.cashFlow.update('none');
        }

        // FUNÇÕES DE TEMA
        function toggleDarkMode() {
            appData.settings.darkMode = !appData.settings.darkMode;
            updateDarkMode();
            saveData();
        }

        function updateDarkMode() {
            const icon = document.getElementById('themeIcon');
            if (appData.settings.darkMode) {
                document.documentElement.classList.add('dark');
                icon.className = 'fas fa-sun text-lg';
            } else {
                document.documentElement.classList.remove('dark');
                icon.className = 'fas fa-moon text-lg';
            }
            setTimeout(() => updateChartsTheme(), 100);
        }

        function updateChartsTheme() {
            if (Object.keys(charts).length === 0) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#E5E7EB' : '#374151';
            const gridColor = isDark ? '#374151' : '#E5E7EB';

            Object.values(charts).forEach(chart => {
                if (chart && chart.options) {
                    if (chart.options.plugins && chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }
                    if (chart.options.scales) {
                        if (chart.options.scales.x) {
                            chart.options.scales.x.ticks.color = textColor;
                            chart.options.scales.x.grid.color = gridColor;
                        }
                        if (chart.options.scales.y) {
                            chart.options.scales.y.ticks.color = textColor;
                            chart.options.scales.y.grid.color = gridColor;
                        }
                    }
                    chart.update('none');
                }
            });
        }

        // FUNÇÕES DE CONFIGURAÇÕES
        function populateSettingsModal() {
            document.getElementById('currencySelect').value = appData.settings.currency;
            document.getElementById('dateFormatSelect').value = appData.settings.dateFormat;
        }

        function saveSettings() {
            appData.settings.currency = document.getElementById('currencySelect').value;
            appData.settings.dateFormat = document.getElementById('dateFormatSelect').value;
            
            saveData();
            closeSettingsModal();
            showNotification('Configurações salvas com sucesso!', 'success');
        }

        function resetSettings() {
            if (confirm('Tem certeza que deseja restaurar as configurações padrão?')) {
                appData.settings.currency = 'BRL';
                appData.settings.dateFormat = 'pt-BR';
                
                populateSettingsModal();
                saveData();
                showNotification('Configurações restauradas!', 'success');
            }
        }

        // FUNÇÕES DE FERRAMENTAS
        function calculateCompoundInterest() {
            const principal = parseCurrencyInput(document.getElementById('compoundPrincipal').value) || 0;
            const monthlyContribution = parseCurrencyInput(document.getElementById('compoundMonthlyContribution').value) || 0;
            const rateYearly = parseFloat(document.getElementById('compoundRate').value) || 0;
            const years = parseFloat(document.getElementById('compoundTime').value) || 0;

            if (years <= 0 || (principal <= 0 && monthlyContribution <= 0)) {
                showNotification('Preencha os campos com valores válidos!', 'error');
                return;
            }

            // Cálculo com aportes mensais e juros compostos
            const rateMonthly = rateYearly / 100 / 12;
            const months = years * 12;
            
            let finalValue;
            let totalInvested = principal + (monthlyContribution * months);

            if (rateYearly === 0) {
                finalValue = totalInvested;
            } else {
                // Valor Futuro = Principal * (1 + r)^n + PMT * [((1 + r)^n - 1) / r]
                const fvPrincipal = principal * Math.pow(1 + rateMonthly, months);
                const fvContributions = monthlyContribution * (Math.pow(1 + rateMonthly, months) - 1) / rateMonthly;
                finalValue = fvPrincipal + fvContributions;
            }

            const earnings = finalValue - totalInvested;

            document.getElementById('compoundResult').classList.remove('hidden');
            document.getElementById('compoundFinalValue').textContent = formatCurrency(finalValue);
            document.getElementById('compoundEarnings').textContent = formatCurrency(earnings);
        }

        function calculateEmergencyFund() {
            const monthlyExpenses = parseCurrencyInput(document.getElementById('monthlyExpenses').value) || 0;
            const months = parseFloat(document.getElementById('emergencyMonths').value) || 6;

            if (monthlyExpenses <= 0) {
                showNotification('Digite um valor válido para os gastos mensais!', 'error');
                return;
            }

            const emergencyAmount = monthlyExpenses * months;
            const currentBalance = appData.transactions
                .reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
            const emergencyGap = Math.max(0, emergencyAmount - currentBalance);

            document.getElementById('emergencyResult').classList.remove('hidden');
            document.getElementById('emergencyAmount').textContent = formatCurrency(emergencyAmount);
            document.getElementById('currentEmergency').textContent = formatCurrency(currentBalance);
            document.getElementById('emergencyGap').textContent = formatCurrency(emergencyGap);
        }

        // FUNÇÕES DE EXPORTAÇÃO/IMPORTAÇÃO
        function exportData() {
            try {
                const dataToExport = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    data: appData
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `finance-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('Dados exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                showNotification('Erro ao exportar dados!', 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.version && importedData.data) {
                        if (confirm('Isso substituirá todos os dados atuais. Tem certeza?')) {
                            appData = dataManager.validateAndMergeData(importedData.data);
                            saveData();
                            updateAllDisplays();
                            updateAllDropdowns();
                            initializeCharts();
                            showNotification('Dados importados com sucesso!', 'success');
                        }
                    } else {
                        showNotification('Arquivo de backup inválido!', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao importar dados:', error);
                    showNotification('Erro ao importar dados!', 'error');
                }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            if (confirm('Tem certeza que deseja limpar TODOS os dados? Esta ação não pode ser desfeita!')) {
                if (confirm('ÚLTIMA CONFIRMAÇÃO: Todos os dados serão perdidos permanentemente (Local e Nuvem)!')) {
                    
                    if (currentUser && isFirebaseInitialized) {
                        showNotification('Removendo dados da nuvem...', 'info');
                        await dataManager.clearFromFirebase(currentUser.uid);
                    }

                    dataManager.clear();
                    location.reload();
                }
            }
        }

        function backupData() {
            exportData();
        }

        function exportTransactions() {
            try {
                const typeFilter = document.getElementById('filterType').value;
                const categoryFilter = document.getElementById('filterCategory').value;
                const monthFilter = document.getElementById('filterMonth').value;

                let filteredTransactions = [...appData.transactions];

                if (typeFilter) {
                    filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
                }
                if (categoryFilter) {
                    filteredTransactions = filteredTransactions.filter(t => t.category === categoryFilter);
                }
                if (monthFilter) {
                    filteredTransactions = filteredTransactions.filter(t => t.date.startsWith(monthFilter));
                }

                const headers = ['Data', 'Tipo', 'Descrição', 'Categoria', 'Valor'];
                const csvContent = [
                    headers.join(','),
                    ...filteredTransactions.map(t => [
                        t.date,
                        t.type === 'income' ? 'Receita' : 'Despesa',
                        `"${t.description}"`,
                        t.category,
                        t.amount.toFixed(2).replace('.', ',')
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `transacoes-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();

                showNotification('Transações exportadas com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar transações:', error);
                showNotification('Erro ao exportar transações!', 'error');
            }
        }

        // REAL DATA SERVICE
        const RealDataService = {
            cache: {},
            
            async getRates() {
                try {
                    // Tenta buscar taxas reais (Selic, CDI)
                    const response = await fetch('https://brasilapi.com.br/api/taxas/v1');
                    const data = await response.json();
                    const selic = data.find(r => r.nome === 'Selic')?.valor || 11.25;
                    const cdi = data.find(r => r.nome === 'CDI')?.valor || 11.15;
                    return { selic, cdi };
                } catch (e) {
                    console.warn('Erro ao buscar taxas:', e);
                    return { selic: 11.25, cdi: 11.15 };
                }
            },

            async getCryptoHistory(id) {
                try {
                    const response = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=brl&days=30`);
                    const data = await response.json();
                    return {
                        prices: data.prices.map(p => p[1]),
                        dates: data.prices.map(p => new Date(p[0]).toLocaleDateString('pt-BR'))
                    };
                } catch (e) {
                    console.warn(`Erro ao buscar cripto ${id}:`, e);
                    return null;
                }
            },

            async getStockHistory(ticker) {
                try {
                    // Usando proxy para Yahoo Finance (Solução Frontend)
                    // Nota: Proxies públicos podem ter limites ou instabilidade
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}.SA?interval=1d&range=1mo`;
                    
                    const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                    const data = await response.json();
                    
                    if (!data.chart || !data.chart.result) return null;
                    
                    const result = data.chart.result[0];
                    const quotes = result.indicators.quote[0].close;
                    const timestamps = result.timestamp;
                    
                    // Filtrar nulls (dias sem pregão)
                    const cleanData = timestamps.map((t, i) => ({
                        date: new Date(t * 1000).toLocaleDateString('pt-BR'),
                        price: quotes[i]
                    })).filter(item => item.price != null);

                    return {
                        prices: cleanData.map(d => d.price),
                        dates: cleanData.map(d => d.date),
                        currentPrice: result.meta.regularMarketPrice
                    };
                } catch (e) {
                    console.warn(`Erro ao buscar ação ${ticker}:`, e);
                    return null;
                }
            },

            async getStockQuote(ticker) {
                // Versão leve apenas para cotação atual
                try {
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}.SA?interval=1d&range=1d`;
                    const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                    const data = await response.json();
                    return data.chart?.result?.[0]?.meta?.regularMarketPrice;
                } catch (e) {
                    return null;
                }
            },

            // Gera curva teórica para renda fixa baseada na taxa anual
            generateFixedIncomeCurve(annualRate, days = 30, baseValue = 1000) {
                const dailyRate = Math.pow(1 + (annualRate / 100), 1 / 252) - 1;
                const prices = [];
                const dates = [];
                let current = baseValue;

                for (let i = days; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    if (date.getDay() !== 0 && date.getDay() !== 6) { // Dias úteis aprox
                        prices.push(current);
                        dates.push(date.toLocaleDateString('pt-BR'));
                        current = current * (1 + dailyRate);
                    }
                }
                return { prices, dates, currentPrice: current };
            }
        };

        // CHART CONFIGURATION
        let assetChartInstance = null;

        async function showAssetDetails(name, ticker, type, price, risk) {
            const modal = document.getElementById('assetDetailModal');
            const titleEl = document.getElementById('assetDetailTitle');
            const subtitleEl = document.getElementById('assetDetailSubtitle');
            const canvas = document.getElementById('assetDetailChart');
            
            // Loading state
            modal.classList.remove('hidden');
            titleEl.textContent = "Carregando dados reais...";
            subtitleEl.textContent = "Conectando às bolsas de valores...";
            
            // Limpar gráfico anterior
            if (assetChartInstance) {
                assetChartInstance.destroy();
            }

            let historyData = { prices: [], dates: [] };
            let currentPrice = price;
            
            // BUSCA DE DADOS REAIS
            try {
                if (type.includes('Cripto')) {
                    // Mapeamento de IDs do CoinGecko
                    const cryptoMap = { 'BTC': 'bitcoin', 'ETH': 'ethereum', 'SOL': 'solana' };
                    const coinId = cryptoMap[ticker] || 'bitcoin';
                    const data = await RealDataService.getCryptoHistory(coinId);
                    if (data) {
                        historyData = data;
                        currentPrice = `R$ ${data.prices[data.prices.length - 1].toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    }
                } 
                else if (type.includes('Ações') || type.includes('FII')) {
                    const data = await RealDataService.getStockHistory(ticker);
                    if (data) {
                        historyData = data;
                        currentPrice = `R$ ${data.currentPrice.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    }
                }
                else if (type.includes('Tesouro') || type.includes('CDB') || type.includes('LCI')) {
                    // Renda Fixa: Curva teórica baseada no CDI/Selic atual
                    const rates = await RealDataService.getRates();
                    const rate = type.includes('IPCA') ? 6.0 : (type.includes('LCI') ? rates.cdi * 0.9 : rates.selic);
                    const baseVal = parseFloat(price.replace(/[^0-9,]/g, '').replace(',', '.')) || 100;
                    const data = RealDataService.generateFixedIncomeCurve(rate, 30, baseVal);
                    historyData = data;
                    // Preço de renda fixa "unitário" é simbólico no gráfico, mas mostra a curva
                }
                else {
                    // Fallback para mock se não reconhecer
                    const mock = generateMockHistoryData(price);
                    historyData = { prices: mock.data, dates: mock.labels };
                }
            } catch (e) {
                console.error("Erro ao carregar gráfico:", e);
                const mock = generateMockHistoryData(price);
                historyData = { prices: mock.data, dates: mock.labels };
            }

            // Atualiza UI com dados finais
            titleEl.textContent = ticker ? `${name} (${ticker})` : name;
            subtitleEl.textContent = `${type} • Risco ${risk} • Atualizado: ${currentPrice}`;

            const ctx = canvas.getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            
            // Cor baseada na variação (primeiro vs último)
            const startPrice = historyData.prices[0] || 0;
            const endPrice = historyData.prices[historyData.prices.length - 1] || 0;
            const color = endPrice >= startPrice ? '#10B981' : '#EF4444';
            
            assetChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyData.dates,
                    datasets: [{
                        label: 'Preço (R$)',
                        data: historyData.prices,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return 'R$ ' + context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { display: false } // Ocultar datas para limpar visual, tooltip mostra
                        },
                        y: {
                            grid: { color: isDark ? '#374151' : '#E5E7EB', borderDash: [5, 5] },
                            ticks: { color: isDark ? '#9CA3AF' : '#4B5563' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // MOCK GENERATOR (FALLBACK)
        function generateMockHistoryData(basePrice, days = 30, volatility = 0.02) {
             const data = [];
             const labels = [];
             let currentPrice = parseFloat(basePrice.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 100;
 
             for (let i = days; i >= 0; i--) {
                 const date = new Date();
                 date.setDate(date.getDate() - i);
                 labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
                 
                 // Random walk
                 const change = currentPrice * volatility * (Math.random() - 0.5);
                 currentPrice += change;
                 data.push(currentPrice);
             }
             return { labels, data };
        }

        function closeAssetDetailModal() {
            document.getElementById('assetDetailModal').classList.add('hidden');
        }
 
         // FUNÇÕES DE MERCADO E SUGESTÕES
        async function updateMarketTicker() {
            const container = document.getElementById('marketTicker');
            
            try {
                container.innerHTML = '<div class="col-span-3 text-center"><i class="fas fa-spinner fa-spin text-primary"></i> Carregando cotações...</div>';
                
                // Tentar buscar dados da API
                const response = await fetch('https://economia.awesomeapi.com.br/last/USD-BRL,EUR-BRL,BTC-BRL');
                const data = await response.json();
                
                const items = [
                    { 
                        code: 'USD', 
                        name: 'Dólar Americano', 
                        value: parseFloat(data.USDBRL.bid), 
                        change: parseFloat(data.USDBRL.pctChange),
                        icon: 'fa-dollar-sign',
                        classes: {
                            border: 'border-green-500',
                            bgIcon: 'bg-green-100',
                            bgIconDark: 'dark:bg-green-900/20',
                            textIcon: 'text-green-600',
                            textIconDark: 'dark:text-green-400'
                        }
                    },
                    { 
                        code: 'EUR', 
                        name: 'Euro', 
                        value: parseFloat(data.EURBRL.bid), 
                        change: parseFloat(data.EURBRL.pctChange),
                        icon: 'fa-euro-sign',
                        classes: {
                            border: 'border-blue-500',
                            bgIcon: 'bg-blue-100',
                            bgIconDark: 'dark:bg-blue-900/20',
                            textIcon: 'text-blue-600',
                            textIconDark: 'dark:text-blue-400'
                        }
                    },
                    { 
                        code: 'BTC', 
                        name: 'Bitcoin', 
                        value: parseFloat(data.BTCBRL.bid), 
                        change: parseFloat(data.BTCBRL.pctChange),
                        icon: 'fa-bitcoin',
                        classes: {
                            border: 'border-yellow-500',
                            bgIcon: 'bg-yellow-100',
                            bgIconDark: 'dark:bg-yellow-900/20',
                            textIcon: 'text-yellow-600',
                            textIconDark: 'dark:text-yellow-400'
                        }
                    }
                ];

                container.innerHTML = items.map(item => `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-l-4 ${item.classes.border} hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full ${item.classes.bgIcon} ${item.classes.bgIconDark} flex items-center justify-center">
                                    <i class="fas ${item.icon} ${item.classes.textIcon} ${item.classes.textIconDark}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800 dark:text-white">${item.code}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${item.name}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-gray-800 dark:text-white">R$ ${item.value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                                <p class="text-xs font-semibold ${item.change >= 0 ? 'text-success' : 'text-danger'}">
                                    <i class="fas ${item.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'} mr-1"></i>
                                    ${item.change}%
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Adicionar timestamp
                const timestamp = new Date().toLocaleTimeString();
                const titleElement = document.querySelector('#marketTicker').previousElementSibling.querySelector('span');
                if(titleElement) {
                    titleElement.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 mr-1 animate-pulse"></span> Atualizado às ${timestamp}`;
                }

            } catch (error) {
                console.error('Erro ao buscar cotações:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-4 text-gray-500">
                        <i class="fas fa-exclamation-circle mb-2"></i>
                        <p>Não foi possível carregar as cotações no momento.</p>
                        <button onclick="updateMarketTicker()" class="mt-2 text-sm text-primary hover:underline">Tentar novamente</button>
                    </div>
                `;
            }
        }

        function updateSuggestions() {
            const profile = document.getElementById('investProfile').value;
            const container = document.getElementById('investmentSuggestions');
            
            const suggestions = {
                conservador: [
                    {
                        title: 'Tesouro Selic',
                        desc: 'Baixo risco, alta liquidez. Ideal para reserva de emergência.',
                        return: 'Selic + 0.1%',
                        risk: 'Muito Baixo',
                        classes: {
                            border: 'border-green-500',
                            bgBadge: 'bg-green-100',
                            textBadge: 'text-green-700',
                            bgBadgeDark: 'dark:bg-green-900/30',
                            textBadgeDark: 'dark:text-green-300',
                            textReturn: 'text-green-600',
                            textReturnDark: 'dark:text-green-400'
                        }
                    },
                    {
                        title: 'CDB Liquidez Diária',
                        desc: 'Segurança do FGC e facilidade de resgate.',
                        return: '100% do CDI',
                        risk: 'Baixo',
                        classes: {
                            border: 'border-blue-500',
                            bgBadge: 'bg-blue-100',
                            textBadge: 'text-blue-700',
                            bgBadgeDark: 'dark:bg-blue-900/30',
                            textBadgeDark: 'dark:text-blue-300',
                            textReturn: 'text-blue-600',
                            textReturnDark: 'dark:text-blue-400'
                        }
                    },
                    {
                        title: 'LCI/LCA',
                        desc: 'Isento de Imposto de Renda. Bom para médio prazo.',
                        return: '90-95% do CDI',
                        risk: 'Baixo',
                        classes: {
                            border: 'border-teal-500',
                            bgBadge: 'bg-teal-100',
                            textBadge: 'text-teal-700',
                            bgBadgeDark: 'dark:bg-teal-900/30',
                            textBadgeDark: 'dark:text-teal-300',
                            textReturn: 'text-teal-600',
                            textReturnDark: 'dark:text-teal-400'
                        }
                    }
                ],
                moderado: [
                    {
                        title: 'Fundos Imobiliários (FIIs)',
                        desc: 'Renda mensal com aluguéis e potencial de valorização.',
                        return: 'DY ~0.8% a.m.',
                        risk: 'Médio',
                        classes: {
                            border: 'border-purple-500',
                            bgBadge: 'bg-purple-100',
                            textBadge: 'text-purple-700',
                            bgBadgeDark: 'dark:bg-purple-900/30',
                            textBadgeDark: 'dark:text-purple-300',
                            textReturn: 'text-purple-600',
                            textReturnDark: 'dark:text-purple-400'
                        }
                    },
                    {
                        title: 'Tesouro IPCA+',
                        desc: 'Proteção contra inflação para longo prazo.',
                        return: 'IPCA + 6%',
                        risk: 'Médio-Baixo',
                        classes: {
                            border: 'border-orange-500',
                            bgBadge: 'bg-orange-100',
                            textBadge: 'text-orange-700',
                            bgBadgeDark: 'dark:bg-orange-900/30',
                            textBadgeDark: 'dark:text-orange-300',
                            textReturn: 'text-orange-600',
                            textReturnDark: 'dark:text-orange-400'
                        }
                    },
                    {
                        title: 'Multimercados',
                        desc: 'Gestão profissional diversificada em vários ativos.',
                        return: 'Variável',
                        risk: 'Médio',
                        classes: {
                            border: 'border-indigo-500',
                            bgBadge: 'bg-indigo-100',
                            textBadge: 'text-indigo-700',
                            bgBadgeDark: 'dark:bg-indigo-900/30',
                            textBadgeDark: 'dark:text-indigo-300',
                            textReturn: 'text-indigo-600',
                            textReturnDark: 'dark:text-indigo-400'
                        }
                    }
                ],
                arrojado: [
                    {
                        title: 'Ações (Bolsa)',
                        desc: 'Potencial de altos retornos com empresas consolidadas.',
                        return: 'Variável',
                        risk: 'Alto',
                        classes: {
                            border: 'border-red-500',
                            bgBadge: 'bg-red-100',
                            textBadge: 'text-red-700',
                            bgBadgeDark: 'dark:bg-red-900/30',
                            textBadgeDark: 'dark:text-red-300',
                            textReturn: 'text-red-600',
                            textReturnDark: 'dark:text-red-400'
                        }
                    },
                    {
                        title: 'Criptomoedas',
                        desc: 'Alta volatilidade e tecnologia disruptiva.',
                        return: 'Variável',
                        risk: 'Muito Alto',
                        classes: {
                            border: 'border-yellow-500',
                            bgBadge: 'bg-yellow-100',
                            textBadge: 'text-yellow-700',
                            bgBadgeDark: 'dark:bg-yellow-900/30',
                            textBadgeDark: 'dark:text-yellow-300',
                            textReturn: 'text-yellow-600',
                            textReturnDark: 'dark:text-yellow-400'
                        }
                    },
                    {
                        title: 'ETFs Internacionais',
                        desc: 'Exposição ao dólar e mercado global (S&P 500).',
                        return: 'Dólar + Variação',
                        risk: 'Alto',
                        classes: {
                            border: 'border-blue-500',
                            bgBadge: 'bg-blue-100',
                            textBadge: 'text-blue-700',
                            bgBadgeDark: 'dark:bg-blue-900/30',
                            textBadgeDark: 'dark:text-blue-300',
                            textReturn: 'text-blue-600',
                            textReturnDark: 'dark:text-blue-400'
                        }
                    }
                ]
            };

            const items = suggestions[profile] || suggestions.moderado;

            container.innerHTML = items.map(item => `
                <div onclick="showAssetDetails('${item.title}', '', '${item.risk}', '${item.return}', '${item.risk}')" class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow hover:shadow-lg transition-all transform hover:-translate-y-1 border-t-4 ${item.classes.border} cursor-pointer">
                    <h4 class="font-bold text-gray-800 dark:text-white mb-2 flex justify-between items-center">
                        ${item.title}
                        <span class="text-xs px-2 py-1 rounded-full ${item.classes.bgBadge} ${item.classes.textBadge} ${item.classes.bgBadgeDark} ${item.classes.textBadgeDark}">${item.risk}</span>
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 h-10">${item.desc}</p>
                    <div class="flex items-center justify-between pt-3 border-t border-gray-100 dark:border-gray-700">
                        <span class="text-xs text-gray-500">Retorno Est.</span>
                        <span class="font-bold ${item.classes.textReturn} ${item.classes.textReturnDark}">${item.return}</span>
                    </div>
                </div>
            `).join('');
        }

        const marketCatalog = {
            rendaFixa: [
                { name: 'Tesouro Selic 2029', type: 'Tesouro Direto', risk: 'Muito Baixo', return: 'Selic + 0.15%', min: 'R$ 150,00', border: 'border-green-500', text: 'text-green-600' },
                { name: 'Tesouro IPCA+ 2029', type: 'Tesouro Direto', risk: 'Baixo', return: 'IPCA + 6.18%', min: 'R$ 30,00', border: 'border-orange-500', text: 'text-orange-600' },
                { name: 'Tesouro IPCA+ 2035', type: 'Tesouro Direto', risk: 'Médio-Baixo', return: 'IPCA + 6.25%', min: 'R$ 40,00', border: 'border-orange-500', text: 'text-orange-600' },
                { name: 'Tesouro Prefixado 2027', type: 'Tesouro Direto', risk: 'Médio', return: '12.5% a.a.', min: 'R$ 35,00', border: 'border-blue-500', text: 'text-blue-600' },
                { name: 'CDB Banco Sofisa', type: 'CDB', risk: 'Baixo', return: '110% do CDI', min: 'R$ 1,00', border: 'border-purple-500', text: 'text-purple-600' },
                { name: 'LCI Banco ABC', type: 'LCI', risk: 'Baixo', return: '93% do CDI (Isento IR)', min: 'R$ 1.000,00', border: 'border-indigo-500', text: 'text-indigo-600' }
            ],
            acoes: [
                { name: 'Vale S.A.', ticker: 'VALE3', type: 'Mineração', risk: 'Médio-Alto', price: 'R$ 60,50', return: 'Div. Yield Alto', border: 'border-red-500', text: 'text-red-600' },
                { name: 'Petrobras PN', ticker: 'PETR4', type: 'Petróleo', risk: 'Médio-Alto', price: 'R$ 38,20', return: 'Div. Yield Alto', border: 'border-red-500', text: 'text-red-600' },
                { name: 'Itaú Unibanco', ticker: 'ITUB4', type: 'Bancos', risk: 'Médio', price: 'R$ 33,15', return: 'Crescimento', border: 'border-blue-500', text: 'text-blue-600' },
                { name: 'Banco do Brasil', ticker: 'BBAS3', type: 'Bancos', risk: 'Médio', price: 'R$ 27,80', return: 'Div. Yield Alto', border: 'border-blue-500', text: 'text-blue-600' },
                { name: 'WEG S.A.', ticker: 'WEGE3', type: 'Indústria', risk: 'Médio', price: 'R$ 52,90', return: 'Valorização', border: 'border-teal-500', text: 'text-teal-600' },
                { name: 'Localiza', ticker: 'RENT3', type: 'Aluguel de Carros', risk: 'Médio', price: 'R$ 45,10', return: 'Crescimento', border: 'border-green-500', text: 'text-green-600' }
            ],
            fiis: [
                { name: 'CSHG Logística', ticker: 'HGLG11', type: 'Tijolo (Logístico)', risk: 'Médio-Baixo', price: 'R$ 162,00', return: 'DY 0.75% a.m.', border: 'border-yellow-500', text: 'text-yellow-600' },
                { name: 'Kinea Rendimentos', ticker: 'KNCR11', type: 'Papel (CDI)', risk: 'Médio', price: 'R$ 103,50', return: 'DY 0.95% a.m.', border: 'border-orange-500', text: 'text-orange-600' },
                { name: 'Maxi Renda', ticker: 'MXRF11', type: 'Híbrido', risk: 'Médio', price: 'R$ 10,25', return: 'DY 1.05% a.m.', border: 'border-red-500', text: 'text-red-600' },
                { name: 'XP Malls', ticker: 'XPML11', type: 'Tijolo (Shoppings)', risk: 'Médio', price: 'R$ 115,80', return: 'DY 0.70% a.m.', border: 'border-blue-500', text: 'text-blue-600' },
                { name: 'Vinci Shopping', ticker: 'VISC11', type: 'Tijolo (Shoppings)', risk: 'Médio', price: 'R$ 120,10', return: 'DY 0.72% a.m.', border: 'border-indigo-500', text: 'text-indigo-600' }
            ],
            cripto: [
                { name: 'Bitcoin', ticker: 'BTC', type: 'Criptomoeda', risk: 'Muito Alto', price: 'R$ 350.000', return: 'Volátil', border: 'border-yellow-500', text: 'text-yellow-600' },
                { name: 'Ethereum', ticker: 'ETH', type: 'Smart Contracts', risk: 'Muito Alto', price: 'R$ 18.500', return: 'Volátil', border: 'border-purple-500', text: 'text-purple-600' },
                { name: 'Solana', ticker: 'SOL', type: 'Blockchain L1', risk: 'Muito Alto', price: 'R$ 850,00', return: 'Volátil', border: 'border-teal-500', text: 'text-teal-600' }
            ]
        };

        async function renderMarketCatalog(category) {
            const container = document.getElementById('marketCatalogContainer');
            const items = marketCatalog[category] || [];
            
            // Update active tab
            document.querySelectorAll('.catalog-tab').forEach(btn => {
                if(btn.dataset.tab === category) {
                    btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });

            // Renderiza estado inicial (cache ou estático)
            const renderItems = (itemList) => {
                container.innerHTML = itemList.map((item, index) => `
                    <div onclick="showAssetDetails('${item.name}', '${item.ticker || ''}', '${item.type}', '${item.min || item.price || '0'}', '${item.risk}')" class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border-l-4 ${item.border} hover:bg-white dark:hover:bg-gray-700 transition-all cursor-pointer group relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800 dark:text-white group-hover:text-primary transition-colors">
                                    ${item.ticker ? `<span class="bg-gray-200 dark:bg-gray-600 px-2 py-0.5 rounded text-xs mr-2">${item.ticker}</span>` : ''}
                                    ${item.name}
                                </h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${item.type}</p>
                            </div>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 whitespace-nowrap">${item.risk}</span>
                        </div>
                        <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <div class="text-center">
                                <p class="text-[10px] uppercase text-gray-500 tracking-wider">Retorno/DY</p>
                                <p class="font-bold ${item.text} text-sm">${item.return}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] uppercase text-gray-500 tracking-wider">${item.min ? 'Invest. Min.' : 'Preço Atual'}</p>
                                <p id="price-${category}-${index}" class="font-bold text-gray-800 dark:text-white text-sm transition-colors duration-500">${item.min || item.price}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            };

            renderItems(items);

            // Atualiza preços reais em segundo plano
            if (category === 'acoes' || category === 'fiis' || category === 'cripto') {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.ticker) {
                        try {
                            let price = null;
                            if (category === 'cripto') {
                                const cryptoMap = { 'BTC': 'bitcoin', 'ETH': 'ethereum', 'SOL': 'solana' };
                                const coinId = cryptoMap[item.ticker] || 'bitcoin';
                                const history = await RealDataService.getCryptoHistory(coinId);
                                if (history && history.prices.length > 0) {
                                    price = history.prices[history.prices.length - 1];
                                }
                            } else {
                                price = await RealDataService.getStockQuote(item.ticker);
                            }

                            if (price) {
                                const el = document.getElementById(`price-${category}-${i}`);
                                if (el) {
                                    el.innerHTML = `R$ ${price.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    el.classList.add('text-green-500');
                                    setTimeout(() => el.classList.remove('text-green-500'), 1000);
                                    
                                    // Atualiza objeto local para persistir na navegação
                                    item.price = `R$ ${price.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                }
                            }
                        } catch (e) {
                            console.warn(`Falha ao atualizar preço de ${item.ticker}`);
                        }
                    }
                }
            }
        }

        // FUNÇÕES UTILITÁRIAS
        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2) + '';
            value = value.replace('.', ',');
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            input.value = value;
        }

        function parseCurrencyInput(value) {
            if (!value) return 0;
            // Remove pontos de milhar e troca vírgula decimal por ponto
            return parseFloat(value.replace(/\./g, '').replace(',', '.'));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat(appData.settings.dateFormat, {
                style: 'currency',
                currency: appData.settings.currency
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString(appData.settings.dateFormat);
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            const colors = {
                success: 'bg-success',
                error: 'bg-danger',
                warning: 'bg-warning',
                info: 'bg-primary'
            };

            notification.className = `notification flex items-center p-4 rounded-xl shadow-xl text-white max-w-sm animate-slide-in ${colors[type] || colors.info}`;
            notification.innerHTML = `
                <i class="fas ${icons[type] || icons.info} mr-3"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-3 text-white/80 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('animate-slide-out');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // INICIALIZAÇÃO DO DOCUMENTO
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - inicializando aplicação...');
            initializeApp();
            showSection('dashboard');
        });

        // ATALHOS DE TECLADO
        document.addEventListener('keydown', function(e) {
            if (e.altKey && e.key === 'r') {
                e.preventDefault();
                openTransactionModal('income');
            }
            if (e.altKey && e.key === 'd') {
                e.preventDefault();
                openTransactionModal('expense');
            }
            if (e.altKey && e.key === 'm') {
                e.preventDefault();
                openGoalModal();
            }
            if (e.altKey && e.key === 'b') {
                e.preventDefault();
                openBudgetModal();
            }
            if (e.key === 'Escape') {
                closeTransactionModal();
                closeGoalModal();
                closeBudgetModal();
                closeInvestmentModal();
                closeSettingsModal();
                if (fabOpen) {
                    toggleFAB();
                }
            }
        });
    </script>
</body>
</html>
